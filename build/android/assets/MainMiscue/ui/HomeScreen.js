var myUserId,r_miscue=require('/MainMiscue/miscue'),r_styles=require('/MainMiscue/ui/styles'),r_loadingScreen=require('/MainMiscue/ui/loadingScreen'),r_Apifile=require('/MainMiscue/ui/Apifile'),r_sessionBookPage=require('/MainMiscue/ui/sessionBookPage'),r_searchSession=require('/MainMiscue/ui/searchSession');(function(){r_miscue.tt.ui.createHomeScreen=function(userName,token,refCheck){function screenHeaderLabel(){titleLabel.top=Ti.Platform.displayCaps.platformWidth>Ti.Platform.displayCaps.platformHeight?this_logoutButton.height+this_logoutButton.top-20:this_logoutButton.height+this_logoutButton.top+10}function createMenupage(winWidth,userId){var menuitemKey='mainmenu',db=Titanium.Database.open('Miscue'),holddatavar=db.execute('SELECT * FROM UserMenuItem WHERE userId = ? AND menuKey = ? ',userId,menuitemKey),i=0,j=0,m=0,tableData=[],colorSetIndex=0,cellIndex=0;if('android'==osname){var tableHeight=Ti.Platform.displayCaps.platformHeight/2;tableHeight/=Titanium.Platform.displayCaps.dpi/160;var tableWidth=Ti.Platform.displayCaps.platformWidth-25;tableWidth/=Titanium.Platform.displayCaps.dpi/160}else{var tableHeight=Ti.Platform.displayCaps.platformHeight/2,tableWidth=Ti.Platform.displayCaps.platformWidth-25;if('ipad'==osname&&Ti.Platform.displayCaps.platformWidth<Ti.Platform.displayCaps.platformHeight)var tableWidth=Ti.Platform.displayCaps.platformWidth-60}(Inch<InchValue||Ti.Platform.displayCaps.platformWidth>Ti.Platform.displayCaps.platformHeight)&&(tableHeight-=15);var homeScreenMenuWidth;tableView=Ti.UI.createTableView({id:10,bottom:'1%',left:10,right:10,width:tableWidth,height:tableHeight,style:Ti.UI.iPhone.TableViewStyle.PLAIN,separatorColor:'transparent',backgroundColor:'transparent',scrollable:!1}),'ipad'==osname&&Ti.Platform.displayCaps.platformWidth<Ti.Platform.displayCaps.platformHeight&&(tableView.left=60);for(var thisRow,count=0,y=1;2>=y;y++){thisRow=Ti.UI.createTableViewRow({className:'grid',id:y,layout:'horizontal',height:tableView.height/2,backgroundColor:'transparent',backgroundSelectedColor:'transparent',separatorColor:'transparent'});for(var x=1;3>=x;x++)if(m<holddatavar.rowCount){var imgData=holddatavar.fieldByName('Image'),Labelname=holddatavar.fieldByName('label_name');Ti.API.log('Label name HomeScreen.js is : ',Labelname);var buttonPosition=holddatavar.fieldByName('Position');Ti.API.log('Button position HomeScreen.js is : ',buttonPosition);var thisView=Ti.UI.createView({top:'3dp',backgroundColor:'transparent',left:'20dp',right:'10dp',height:thisRow.height-5,width:tableView.width/3-35,buttonid:buttonPosition,idss:Labelname});homeScreenMenuHeight=thisView.height-65,homeScreenMenuWidth=thisView.height-58,'iPhone OS'==Ti.Platform.name?'ipad'==osname&&(homeScreenMenuHeight=thisView.height-75,homeScreenMenuWidth=thisView.height-32):'android'==Ti.Platform.name&&Inch>=InchValue&&(homeScreenMenuHeight=thisView.height-65,homeScreenMenuWidth=thisView.height-32,Ti.Platform.displayCaps.platformWidth>Ti.Platform.displayCaps.platformHeight&&(homeScreenMenuWidth=thisView.height-50)),'ipad'==osname&&(thisView.width=180),320==Titanium.Platform.displayCaps.dpi&&Inch>=InchValue&&(thisView.width=150),thisView.height<tableView.width/3-35&&(thisView.width=thisRow.height-5),Ti.Platform.displayCaps.platformWidth>Ti.Platform.displayCaps.platformHeight?((1==x&&1==y||1==x&&2==y)&&(thisView.left=tableView.width/3-(thisView.width-40),thisView.right='15dp'),2==holddatavar.rowCount&&1==x&&1==y&&(thisView.left=thisView.left+thisView.width/2+20,thisView.right='15dp'),4==holddatavar.rowCount&&1==x&&2==y&&(thisView.left=thisView.left+thisView.width+35,thisView.right='15dp'),5==holddatavar.rowCount&&1==x&&2==y&&(thisView.left=thisView.left+thisView.width/2+15,thisView.right='15dp')):(2==holddatavar.rowCount&&1==x&&1==y&&(thisView.left=thisView.width/2+15,thisView.right='15dp'),4==holddatavar.rowCount&&1==x&&2==y&&(thisView.left=thisView.width+35,thisView.right='15dp'),5==holddatavar.rowCount&&1==x&&2==y&&(thisView.left=thisView.width/2+20,thisView.right='15dp'));var thisButtonIcon=Ti.UI.createImageView(r_miscue.tt.combine(r_styles.$$.boldHeaderText,{width:homeScreenMenuWidth,height:homeScreenMenuHeight,bottom:Inch>=InchValue?'66dp':'55dp',idss:Labelname,buttonid:buttonPosition,idss:Labelname,backgroundColor:'transparent',style:Titanium.UI.iPhone.SystemButtonStyle.PLAIN,image:imgData,touchEnabled:!1}));120<thisButtonIcon.height&&(thisButtonIcon.height='android'==osname?'120dp':'130dp'),130<thisButtonIcon.width&&(thisButtonIcon.width='android'==osname?'130dp':'140dp'),thisButtonIcon.width>thisView.width&&(thisButtonIcon.width=thisView.width),thisLabel=Ti.UI.createLabel({color:fontcolour,backgroundColor:'transparent',left:'0dp',textAlign:'center',font:{fontSize:Inch>=InchValue?'20dp':'12dp',fontWeight:'bold',fontFamily:pagefontfamily},text:Labelname,height:'74dp',touchEnabled:!1,width:'96%',buttonid:buttonPosition,idss:Labelname,bottom:'0dp'}),Ti.Platform.displayCaps.platformWidth>Ti.Platform.displayCaps.platformHeight&&(thisButtonIcon.bottom='63dp',thisButtonIcon.width-=20,thisLabel.font={fontSize:'18dp',fontWeight:'bold',fontFamily:pagefontfamily}),thisButtonIcon.height=thisButtonIcon.width,26<thisLabel.text.length&&(thisLabel.text=thisLabel.text.substring(0,24)+'..'),thisButtonIcon.borderWidth=0,thisView.add(thisButtonIcon),thisView.add(thisLabel),thisRow.add(thisView),cellIndex++,colorSetIndex++,count++,holddatavar.next(),m++}tableData.push(thisRow)}return db.close(),tableView.data=tableData,homeWin.add(tableView),homeWin.addEventListener('focus',function(e){clickCount=0}),tableView.addEventListener('click',tableViewClickEvent),tableData}function tableViewClickEvent(e){Ti.Gesture.removeEventListener('orientationchange',orientionChangeMode);var index=e.index,row=e.source.ids,buttonPositionValue=e.source.buttonid,labelText=e.source.idss;clickCount++;var closeWindow=!0;if(null!=buttonPositionValue){var db=Titanium.Database.open('Miscue'),homescrn=db.execute('SELECT * FROM UserMenuItem WHERE Position = ? AND userId = ? AND menuKey = ?',buttonPositionValue,userId,'mainmenu');if(0<homescrn.rowCount)var hmvalue=homescrn.fieldByName('Type'),buttonId=homescrn.fieldByName('menuItemKey');homescrn.close(),db.close()}if('standard'==hmvalue){if(1==clickCount&&'miscueanalysis'==buttonId){var base_URL='https://www.miscue.co.uk/iglooapi/apirequest.aspx',classStr='<request><requesttype>GETCLASSES</requesttype><accesstoken>'+token+'</accesstoken></request>',flg=2;if(Ti.API.log('Miscue analysis Called HomeScreen.js:: ','Miscue analysis Called'),Ti.Network.online){homeWin.touchEnabled=!1;var labelArray=[];labelArray.message=['loading_Indicator','Loading...'],r_loadingScreen.showActivity(labelArray.message,userName),r_Apifile.createApi(base_URL,classStr,userName,token,flg,homeWin,buttonId),homeWin.touchEnabled=!0}else if(!Ti.Network.online){var miscuewindow=r_miscue.tt.ui.createmiscueMenuPage(userName,token,buttonId);miscuewindow.open(),homeWin.close()}}setTimeout(function(){clickCount=0},500)}else if('webview'==hmvalue){if(Ti.API.log('WebView Called HomeScreen.js :: ','WebView Called'),Ti.App.Properties.setString('isConvertedToDP','false'),1==clickCount){closeWindow=!1;var db=Titanium.Database.open('Miscue'),homescrn=db.execute('SELECT * FROM UserMenuItem where menuItemKey = ? AND userId = ?',buttonId,userId),hmlink=homescrn.fieldByName('Link');Ti.Platform.openURL(hmlink)}setTimeout(function(){clickCount=0},500)}closeWindow&&tableView.removeEventListener('click',tableViewClickEvent)}function createChangeAlignmentPositions(orientVal,orientationVal){Ti.API.log('createChangeAlignmentPositions() called :: ',orientVal+' :: '+orientationVal);var screenRes=r_loadingScreen.backgroundImageHeightWidthPxToDp();homeScreenBackgroundImage.height=screenRes[1],homeScreenBackgroundImage.width=screenRes[0],titleLabel.top=Ti.Platform.displayCaps.platformWidth>Ti.Platform.displayCaps.platformHeight?this_logoutButton.height+this_logoutButton.top-10:this_logoutButton.height+this_logoutButton.top+10,orientCount=orientationVal;var portraitval=r_loadingScreen.dptopixel(),lwidth=Ti.Platform.displayCaps.platformWidth;for(var x in clickCount=0,tableView.removeEventListener('click',tableViewClickEvent),homeWin.children)if(3<=homeWin.children.length){tableDataValue=null,homeWin.remove(tableView);break}tableDataValue=createMenupage(lwidth,userId),screenHeaderLabel(),Ti.API.info('Finished createChangeAlignmentPositions')}function getOrientation(orientVal){var value;return value=1===orientVal?1:4===orientVal?2:2===orientVal?3:3===orientVal?4:0,Ti.API.log('getOrientation() called :: ',value),value}function orientionChangeMode(e){return;Ti.API.info('---------- BEN - e = '+e);var orientVal=e.source.orientation;Ti.API.info('---------- BEN - e.source.orientation = '+orientVal);var orientationVal=getOrientation(orientVal);Ti.API.info('---------- BEN - orientationVal = '+orientationVal),(Inch>=InchValue||'ipad'==osname)&&('android'==osname?(Ti.API.log('orientionChangeMode() called :: ','orientionChangeMode() called'),Ti.API.info('---------- BEN - createChangeAlignmentPositions called 1'),createChangeAlignmentPositions(orientVal,orientationVal)):orientationVal!=orientCount&&0!=orientationVal&&(Ti.API.info('---------- BEN - createChangeAlignmentPositions called 2'),createChangeAlignmentPositions(orientVal,orientationVal)))}var osname=Ti.Platform.osname;Ti.API.info('home screen page');var pWidth=Ti.Platform.displayCaps.platformWidth,db=Titanium.Database.open('Miscue'),homelog=db.execute('SELECT * FROM Login WHERE username =?',userName),userId=homelog.fieldByName('userid');myUserId=userId;var logflag=homelog.fieldByName('logoutFlag');homelog.close(),homelog=null,Ti.App.Properties.setString('isConvertedToDP','true');var logout_title='LOG OUT',language_labelname_row=db.execute('SELECT * FROM Language WHERE userId =? AND labelId = ?',userName,'LOG OUT');0<language_labelname_row.rowCount&&(logout_title=language_labelname_row.fieldByName('label'));var homerow=db.execute('SELECT * FROM UserSetting where loginId =?',userId);Ti.Network.online||db.execute('UPDATE Language SET isLastUsedLang=? WHERE userId = ?','true',userName);var schoolnames=homerow.fieldByName('schoolName'),pagebackground=homerow.fieldByName('backPage'),backgroundcolor=homerow.fieldByName('backgroundColor'),fontcolour=homerow.fieldByName('fontColor'),pagefontfamily=homerow.fieldByName('charFont'),pagelogo=homerow.fieldByName('logos'),homeWindowBackgroundImage=homerow.fieldByName('homePageBackgroundImage'),dec=Ti.Utils.base64decode(schoolnames),logoutImage=homerow.fieldByName('logoutImageURL');db.execute('UPDATE UserSetting SET islastUsedBrandLogo=? WHERE loginId = ?','true',userId);var isLandscape='false';homerow.close(),db.close();var iOS7=r_loadingScreen.isiOS7Plus(),homeWin=Ti.UI.createWindow({navBarHidden:!0,backgroundColor:backgroundcolor,tabBarHidden:!0}),homeScreenBackgroundImageView=Ti.UI.createView({backgroundColor:'transparent',height:Titanium.UI.FILL,width:Titanium.UI.FILL});homeWin.add(homeScreenBackgroundImageView);var homeScreenBackgroundImage=Ti.UI.createImageView({top:'0dp',defaultImage:'/images/default.png',image:homeWindowBackgroundImage});homeScreenBackgroundImageView.add(homeScreenBackgroundImage);var Inch=r_loadingScreen.screenInch(),screenRes=r_loadingScreen.backgroundImageHeightWidthPxToDp();homeScreenBackgroundImage.height=screenRes[1],homeScreenBackgroundImage.width=screenRes[0];var this_logoutButton=Ti.UI.createView({backgroundColor:'transparent',top:'iphone'==Ti.Platform.osname?4:10,height:80,width:145,right:'10dp',id:'home_logout'}),this_logoutButtonIcon=Ti.UI.createImageView({defaultImage:'/images/LOGOUT.png',height:Titanium.UI.SIZE,width:Titanium.UI.SIZE,image:logoutImage}),logoutLabel=Ti.UI.createLabel({font:{fontFamily:'Helvetica Neue',fontSize:'15dp',fontWeight:'bold',fontFamily:'Roboto',fontSize:'15dp',fontWeight:'bold'},text:logout_title,color:fontcolour,width:'100%',textAlign:Titanium.UI.TEXT_ALIGNMENT_CENTER});this_logoutButton.add(this_logoutButtonIcon),7<=iOS7&&(homeWin.top='20dp'),'iphone'==osname&&(this_logoutButton.height=48,this_logoutButton.width=78),Inch<InchValue&&'android'==osname?(this_logoutButton.height=50,this_logoutButton.width=80,homeWin.orientationModes=[Titanium.UI.PORTRAIT]):'android'==osname&&(homeWin.orientationModes=[Titanium.UI.PORTRAIT]);var titleLabel=Ti.UI.createLabel({color:'#CEDEE6',width:pWidth,font:{fontSize:Inch<InchValue?'15dp':'30dp',fontWeight:'bold'},textAlign:'center',text:dec,touchEnabled:!1});screenHeaderLabel(),homeWin.add(titleLabel);var pendingSessionLabelArray=[];pendingSessionLabelArray.title=['Alert','Alert'],pendingSessionLabelArray.message=['confirm_upload','There are outstanding sessions that have not been uploaded. Do you want to upload these session now?'],pendingSessionLabelArray[1]=['Upload','Upload'],pendingSessionLabelArray[2]=['Cancel','Cancel'];var submissionVerficatioDialog=createLocalizedAlertDialog(pendingSessionLabelArray,userName),onlineValue=1,networkCheck=function(e){if(!0==e.online||1==e.online){var db=Titanium.Database.open('Miscue'),miscueSavePendingSessionToServerRow=db.execute('SELECT * FROM MiscueSession WHERE userId = ? AND  (lastSavedToServerDate < lastModifiedDate OR lastSavedToServerDate = ?)',userId,'null'),interval=2e3*miscueSavePendingSessionToServerRow.rowCount;0<miscueSavePendingSessionToServerRow.rowCount?(db.close(),miscueSavePendingSessionToServerRow.close(),miscueSavePendingSessionToServerRow=null,onlineValue=e.online,submissionVerficatioDialog.show()):(miscueSavePendingSessionToServerRow.close(),miscueSavePendingSessionToServerRow=null,db.close(),db=null)}};if(submissionVerficatioDialog.addEventListener('click',function(e){if(0==e.index){homeWin.touchEnabled=!1;var labelArray=[];labelArray.message=['loading_Indicator','Please wait..'],r_loadingScreen.showActivity(labelArray.message,userName),r_searchSession.createSubmitPendingSessionToServer(userId,token,homeWin,onlineValue)}}),Ti.Network.addEventListener('change',networkCheck),Ti.Network.online){var db=Titanium.Database.open('Miscue'),miscueSavePendingSessionToServerRow=db.execute('SELECT * FROM MiscueSession WHERE userId = ? AND  (lastSavedToServerDate < lastModifiedDate OR lastSavedToServerDate = ?)',userId,'null'),interval=2e3*miscueSavePendingSessionToServerRow.rowCount;0<miscueSavePendingSessionToServerRow.rowCount?(miscueSavePendingSessionToServerRow.close(),miscueSavePendingSessionToServerRow=null,db.close(),setTimeout(function(){submissionVerficatioDialog.show()},'iPhone OS'===Ti.Platform.name?0:1e3)):(db.close(),miscueSavePendingSessionToServerRow.close(),miscueSavePendingSessionToServerRow=null)}homeWin.addEventListener('close',function(e){Ti.Network.removeEventListener('change',networkCheck)});var top=r_loadingScreen.titleLabeltop();homeWin.add(this_logoutButton);var isProcessInProgress=!0;if(this_logoutButton.addEventListener('click',function(e){if(!0==isProcessInProgress){Ti.Gesture.removeEventListener('orientationchange',orientionChangeMode),isProcessInProgress=!1,homeWin.touchEnabled=!1;var labelArray=[];labelArray.message=['pleasewait_Indicator','Please wait..'],r_loadingScreen.showActivity(labelArray.message,userName);var db=Titanium.Database.open('Miscue'),homelogs=db.execute('SELECT * FROM Login WHERE logoutFlag = ? AND userid=?',2,userId);db.execute('UPDATE Login SET logoutFlag=? WHERE userid=?',2,userId),db.close(),setTimeout(function(){tableView.removeAllChildren(),homeWin.remove(tableView),this_logoutButton.remove(this_logoutButtonIcon),this_logoutButton.remove(logoutLabel),homeWin.remove(this_logoutButton),this_logoutButtonIcon=null,logoutLabel=null,this_logoutButton=null,top=null;var loginWin=r_miscue.tt.ui.createLoginPage();loginWin.open(),r_loadingScreen.hideActivity(),homeWin.close(),homeWin=null,Inch=null},500)}}),'android'==Ti.Platform.osname){var back_Count=0;homeWin.addEventListener('android:back',function(){if(!0==isProcessInProgress){isProcessInProgress=!1,homeWin.touchEnabled=!1;var labelArray=[];labelArray.title=['Logout','Logout'],labelArray.message=['home_logout_confirmation_message','Are you sure you want to logout?'],labelArray[1]=['Confirm','Confirm'],labelArray[2]=['Cancel','Cancel'];var dialog=createLocalizedAlertDialog(labelArray,userName);dialog.show(),dialog.addEventListener('click',function(e){if(0==e.index){Ti.Gesture.removeEventListener('orientationchange',orientionChangeMode);var labelArray=[];labelArray.message=['pleasewait_Indicator','Please wait..'],r_loadingScreen.showActivity(labelArray.message,userName);var logFalgs=2;logFalgs=logFalgs.toString();var db=Titanium.Database.open('Miscue');db.execute('UPDATE Login SET logoutFlag=? WHERE userid=?',logFalgs,userId),db.close(),setTimeout(function(){tableView.removeAllChildren(),homeWin.remove(tableView),this_logoutButton.remove(this_logoutButtonIcon),this_logoutButton.remove(logoutLabel),homeWin.remove(this_logoutButton),this_logoutButtonIcon=null,logoutLabel=null,this_logoutButton=null,top=null;var loginWin=r_miscue.tt.ui.createLoginPage();loginWin.open(),r_loadingScreen.hideActivity(),homeWin.close(),homeWin=null,Inch=null},500)}0!=e.index&&(isProcessInProgress=!0,homeWin.touchEnabled=!0)}),dialog.show(),setTimeout(function(){back_Count=0},500)}})}var tableView,clickCount,tableDataValue;tableDataValue=Ti.Platform.displayCaps.platformWidth<Ti.Platform.displayCaps.platformHeight?createMenupage(pWidth,userId):createMenupage(pWidth,userId);var orientCount=6;return'1'!=Ti.App.Properties.getString('doNetworkCheck')||!0!=Ti.Network.online||!0,Ti.Gesture.addEventListener('orientationchange',orientionChangeMode),homeWin}})();var r_miscueMenuPage=require('/MainMiscue/ui/miscueMenuPage'),r_HomeWebView='/MainMiscue/ui/HomeWebview';function createLocalizedAlertDialog(labelArray,userId){var labelIdList=[],buttonLabelArray=[];labelIdList[0]=labelArray.title[0],labelIdList[1]=labelArray.message[0];for(var inPlaceholder='( ?,?',j=1;!0&&!(null==labelArray[j]);){inPlaceholder+=',';labelIdList[j+1]=labelArray[j][0],inPlaceholder+='?',j++}inPlaceholder+=')';var db=Titanium.Database.open('Miscue'),paramList=[userId];paramList=paramList.concat(labelIdList);var localizedAlertLabelnamerow=db.execute('SELECT * FROM Language WHERE userId =? AND labelId IN '+inPlaceholder,paramList);if(0<localizedAlertLabelnamerow.rowCount){for(var i=0;i<localizedAlertLabelnamerow.rowCount;i++){var labelName=localizedAlertLabelnamerow.fieldByName('label'),labelId=localizedAlertLabelnamerow.fieldByName('labelId');labelArray.title[0]==labelId&&(labelArray.title[1]=labelName),labelArray.message[0]==labelId&&(labelArray.message[1]=labelName);for(var j=1;!0&&!(null==labelArray[j+1]);)labelArray[j+1][0]==labelId&&(labelArray[j+1][1]=labelName),j++;localizedAlertLabelnamerow.next()}db.close()}else db.close();for(var j=1;!0&&!(null==labelArray[j]);)buttonLabelArray.push(labelArray[j][1]),j++;var dialog=Ti.UI.createAlertDialog({message:labelArray.message[1],buttonNames:buttonLabelArray,title:labelArray.title[1]});return dialog}exports.createLocalizedAlertDialog=createLocalizedAlertDialog;function createLocalizedShowToastMessage(labelArray,userId){var labelIdList=[];labelIdList=labelArray[0];var db=Titanium.Database.open('Miscue'),paramList=[userId];paramList=paramList.concat(labelIdList);var localizedAlertLabelnamerow=db.execute('SELECT * FROM Language WHERE userId = ? AND labelId IN (?)',userId,labelIdList);if(0<localizedAlertLabelnamerow.rowCount){for(var i=0;i<localizedAlertLabelnamerow.rowCount;i++){var labelName=localizedAlertLabelnamerow.fieldByName('label'),labelId=localizedAlertLabelnamerow.fieldByName('labelId');labelArray[0]==labelId&&(labelArray[1]=labelName),localizedAlertLabelnamerow.next()}db.close()}else db.close();indWin=Titanium.UI.createWindow({top:'200dp'});var indView=Titanium.UI.createView({height:'60dp',width:'180dp',borderRadius:10,backgroundColor:'#aaa',opacity:.7});indWin.add(indView);var message=Titanium.UI.createLabel({text:labelArray[1],color:'black',width:indView.width,height:indView.height,textAlign:'center',font:{fontFamily:'Helvetica Neue',fontSize:15,fontWeight:'bold',fontFamily:'Roboto',fontSize:15,fontWeight:'bold'}});indView.add(message),indWin.open();var interval=1e3;setTimeout(function(){indWin.close({opacity:0,duration:2e3})},interval)}exports.createLocalizedShowToastMessage=createLocalizedShowToastMessage;function createActivityIndicator(message){var indView=Titanium.UI.createView({height:'65dp',width:'160dp',borderWidth:2,borderRadius:10,borderColor:'#aaa',backgroundColor:'black'}),activityIndicator=Ti.UI.createActivityIndicator({color:'white',height:'auto',width:'auto',font:{fontFamily:'Helvetica Neue',fontSize:'15dp',fontWeight:'bold',fontFamily:'Roboto',fontSize:15,fontWeight:'bold'},message:message,style:Ti.UI.iPhone.ActivityIndicatorStyle.BIG});return indView.add(activityIndicator),[indView,activityIndicator]}function createSubmitMiscueSession(userId,sessionGuid,token,sessionWindow,isSessionBookPage,tokenDuplicate,file,sliderValue){Ti.API.info('slider value got here '+sliderValue),Ti.API.info('---------- BEN - Creating session on local (I think) database. token = \''+token+'\' & tokenDuplicate = \''+tokenDuplicate+'\''),Ti.API.info('---------- BEN - file = \''+file+'\'');var newSessionStatus,miscueDataXml,db=Titanium.Database.open('Miscue'),checkEditSessionRow=db.execute('SELECT * FROM MiscueSession WHERE sessionGuid = ?',sessionGuid);if(0<checkEditSessionRow.rowCount){var isModified=checkEditSessionRow.fieldByName('isSessionModified'),modifiedDate=checkEditSessionRow.fieldByName('lastModifiedDate'),sessionstatus=checkEditSessionRow.fieldByName('sessionStatus'),lastSavedToServer=checkEditSessionRow.fieldByName('lastSavedToServerDate'),sessionNote=checkEditSessionRow.fieldByName('sessionNotes'),bookguid=checkEditSessionRow.fieldByName('bookGUID'),sliderValueLocal=checkEditSessionRow.fieldByName('sliderValue'),learnerGuid=checkEditSessionRow.fieldByName('learnerGuid');Ti.API.info('---------- BEN - Doing your fix and adding recordedAudioFilename to the database.'),db.execute('UPDATE MiscueSession SET recordedAudioFilename = ? WHERE sessionGuid = ? AND userId = ? AND learnerGuid = ?',file,sessionGuid,userId,learnerGuid),Ti.API.info('---------- BEN - 2'),Ti.API.info('slider value got from db at submit '+sliderValueLocal+' :bookguid '+bookguid+' user id '+userId+' learner guid'+learnerGuid),('true'==isModified||'DRAFT'==sessionstatus||'null'==lastSavedToServer||modifiedDate>lastSavedToServer)&&(Ti.API.info('---------- BEN - 3'),'DRAFT'==sessionstatus?newSessionStatus='CREATED':'CREATED'==sessionstatus?(newSessionStatus='CREATED','null'!=lastSavedToServer&&(newSessionStatus='EDITED')):'EDITED'==sessionstatus&&(newSessionStatus='EDITED'),db.execute('UPDATE MiscueSession SET isLastEditedSession = ? WHERE userId = ?','false',userId),Ti.API.info('new trace slider value change here for db '+sliderValueLocal),db.execute('UPDATE MiscueSession SET isSessionModified = ?,isLastEditedSession = ?,lastModifiedDate = ?,sessionStatus = ?,sliderValue = ? WHERE sessionGuid = ? AND userId = ? AND learnerGuid = ?','false','true',r_sessionBookPage.createDate(),newSessionStatus,sliderValueLocal,sessionGuid,userId,learnerGuid),db.close(),Ti.Network.online&&createSaveMiscueSessionToServer(userId,sessionGuid,token,sessionWindow,isSessionBookPage,file,sliderValue)),Ti.API.info('---------- BEN - 4')}else db.close()}exports.createSubmitMiscueSession=createSubmitMiscueSession;function createMiscueXmlData(sessionGuid,userId){var temp='',db=Titanium.Database.open('Miscue'),miscueSessionItemRow=db.execute('SELECT * FROM MiscueSessionItem WHERE miscueSessionId = ?',sessionGuid);if(0<miscueSessionItemRow.rowCount)for(var i=0;i<miscueSessionItemRow.rowCount;i++){var note=miscueSessionItemRow.fieldByName('noteText'),miscuemenu=miscueSessionItemRow.fieldByName('miscueMenu');miscuemenu=miscuemenu.split('"'),miscuemenu=miscuemenu[0];var startcharVal=miscueSessionItemRow.fieldByName('startChar'),endcharVal=miscueSessionItemRow.fieldByName('endChar'),additionalInfo=miscueSessionItemRow.fieldByName('additionalInfo'),apiRef=miscueSessionItemRow.fieldByName('apiRef');'miscue_reversal'==miscuemenu&&(miscuemenu='REVERSAL',note=additionalInfo),'undefined'==note&&(note=' '),' '!=note&&(note=note.replace(/&/gi,'&amp;'),note=note.replace(/</gi,'&lt;'),note=note.replace(/>/gi,'&gt;'),note=note.replace(/"/gi,'&quot;')),miscuemenu=miscuemenu.toUpperCase(),miscueDataXml='<miscue type="'+apiRef+'" startchar="'+startcharVal+'" endchar="'+endcharVal+'">'+note+'</miscue>',miscueDataXml=temp+miscueDataXml,temp=miscueDataXml,miscueSessionItemRow.next()}else miscueDataXml=' ';return db.close(),miscueDataXml}exports.createMiscueXmlData=createMiscueXmlData;function createSaveMiscueSessionToServer(userId,sessionGuid,token,sessionWindow,isSessionBookPage,file,sliderValue){Ti.API.info('slider value got to save miscue sesison'+sliderValue);var saveMiscue,cnt=0,flag=7,sessionGUID=[],sessionDate=[],miscuesessionDate=[],learnerGUID=[],bookGUID=[],miscues=[],session_Id=[],sessionNotes=[],modalId=[],sessionStatus=[],db=Titanium.Database.open('Miscue'),loginUserNameRow=db.execute('SELECT * FROM Login WHERE userid = ?',userId),loginUserName=loginUserNameRow.fieldByName('username');loginUserNameRow.close();var base_URL='https://www.miscue.co.uk/iglooapi/apirequest.aspx',miscueSaveSessionToServerRow=db.execute('SELECT * FROM MiscueSession WHERE userId = ? AND sessionGuid = ? AND (lastSavedToServerDate < lastModifiedDate OR lastSavedToServerDate = ?)',userId,sessionGuid,'null'),rowCount=miscueSaveSessionToServerRow.rowCount;Ti.API.info('row count at save session '+rowCount);try{if(0<rowCount){for(;miscueSaveSessionToServerRow.isValidRow();)sessionStatus[cnt]=miscueSaveSessionToServerRow.fieldByName('sessionStatus'),sessionGUID[cnt]=miscueSaveSessionToServerRow.fieldByName('sessionGuid'),'CREATED'==sessionStatus[cnt]?sessionDate[cnt]=miscueSaveSessionToServerRow.fieldByName('sessiondate'):('EDITED'==sessionStatus[cnt]||'DELETED'==sessionStatus[cnt])&&(sessionDate[cnt]=miscueSaveSessionToServerRow.fieldByName('lastModifiedDate')),learnerGUID[cnt]=miscueSaveSessionToServerRow.fieldByName('learnerGuid'),bookGUID[cnt]=miscueSaveSessionToServerRow.fieldByName('bookGUID'),sessionNotes[cnt]=miscueSaveSessionToServerRow.fieldByName('sessionNotes'),sessionNotes[cnt]=sessionNotes[cnt].replace(/&/gi,'&amp;'),sessionNotes[cnt]=sessionNotes[cnt].replace(/</gi,'&lt;'),sessionNotes[cnt]=sessionNotes[cnt].replace(/>/gi,'&gt;'),sessionNotes[cnt]=sessionNotes[cnt].replace(/"/gi,'&quot;'),miscues[cnt]=createMiscueXmlData(sessionGUID[cnt],userId),cnt++,miscueSaveSessionToServerRow.next();db.close();for(var x=0;x<rowCount;x++)saveMiscueXML='<request><requesttype>SAVEMISCUE</requesttype><status>'+sessionStatus[x]+'</status><accesstoken>'+token+'</accesstoken><sessionGUID>'+sessionGUID[x]+'</sessionGUID><sessionDate>'+sessionDate+'</sessionDate><learnerGUID>'+learnerGUID[x]+'</learnerGUID><bookGUID>'+bookGUID[x]+'</bookGUID><notes>'+sessionNotes[x]+'</notes><sliderValue>'+sliderValue+'</sliderValue><miscues>'+miscues[x]+'</miscues> </request>',Ti.API.info('---------- BEN - doing createApi. Flag = '+flag),r_Apifile.createApi(base_URL,saveMiscueXML,loginUserName,userId,flag,sessionWindow,sessionGuid,isSessionBookPage,token,file),Ti.API.info('---------- BEN - TEST COMPLETE')}}finally{}}exports.createSaveMiscueSessionToServer=createSaveMiscueSessionToServer;