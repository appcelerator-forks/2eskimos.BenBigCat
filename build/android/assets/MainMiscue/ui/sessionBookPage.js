var r_miscue=require('/MainMiscue/miscue'),r_loadingScreen=require('/MainMiscue/ui/loadingScreen'),r_styles=require('/MainMiscue/ui/styles'),r_Miscuedb=require('/MainMiscue/model/Miscuedb'),r_searchSession=require('/MainMiscue/ui/searchSession');(function(){r_miscue.tt.ui.createBookNameWindow=function(usrname,learnerGuid,learnername,token,groupname,button_Id,user_Id,menuItemKey){function orientionChangeMode(e){return;var screenRes=r_loadingScreen.backgroundImageHeightWidthPxToDp();screenBackgroundImage[1].width=screenRes[0],Ti.Platform.displayCaps.platformWidth>Ti.Platform.displayCaps.platformHeight?(Inch>=InchValue||'ipad'==osname)&&(screenBackgroundImage[1].height=screenRes[1],Ti.API.info('or change landscape'+screenBackgroundImage[1].height),backView.height=70,backView.width=135):('ipad'==osname||'iphone'==osname?(screenBackgroundImage[1].height=Titanium.Platform.displayCaps.platformHeight-Titanium.Platform.displayCaps.platformHeight/2.5,Ti.API.info('or change portrair ipad and iPhone'+screenBackgroundImage[1].height)):(screenBackgroundImage[1].height=Titanium.Platform.displayCaps.platformHeight/(Titanium.Platform.displayCaps.dpi/120),Ti.API.info('or change portrair android'+screenBackgroundImage[1].height)),Inch>=InchValue&&('iphone'==osname||'ipad'==osname?(screenBackgroundImage[1].height=Titanium.Platform.displayCaps.platformHeight,Ti.API.info('or change inch > value portrair iphone or ipad'+screenBackgroundImage[1].height)):(screenBackgroundImage[1].height=Titanium.Platform.displayCaps.platformHeight/(Titanium.Platform.displayCaps.dpi/100),Ti.API.info('or change inch > value portrair android'+screenBackgroundImage[1].height)),backView.height=80,backView.width=145));var portraitval=r_loadingScreen.dptopixel()}function createDayMonthYear(){var dateValue=new Date;return dayNames[dateValue.getDay()]+' '+dateValue.getDate()+' '+monthNames[dateValue.getMonth()]}function createTime(){var currentTime=new Date,hours=currentTime.getHours(),minutes=currentTime.getMinutes();10>minutes&&(minutes='0'+minutes);var suffix='AM';return 12<=hours&&(suffix='PM',hours-=12),0==hours&&(hours=12),hours+':'+minutes+' '+suffix}function tableViewClickEvent(e){var book_GUID=e.rowData.id,db=Titanium.Database.open('Miscue'),notesTemplateRow=db.execute('SELECT * FROM UserBook WHERE bookGuid = ? AND userId = ?',e.rowData.id,user_Id);0<notesTemplateRow.rowCount&&(notesTemplateValue=notesTemplateRow.fieldByName('notesTemplate')),notesTemplateRow.close(),notesTemplateRow=null,db.close(),db=null;var isSessionBookPage='book',session_Guid=Ti.Platform.createUUID(),msicue_DataXml='',session_Status='DRAFT',accuaracy_Value='100.00',lastmodified_Date='',lastSavedServer_Date=null,isLastEdited_Session='true',isSession_Modified='true',session_Date=new Date;if(session_Date=session_Date.toISOString(),Ti.API.info('---------- BEN - insertMiscueSession called 1 (from sessionBookPage). recordedFileName parameter is hardcoded as \'null\'!'),r_Miscuedb.insertMiscueSession(session_Guid,user_Id,msicue_DataXml,session_Date,book_GUID,session_Status,learnerGuid,accuaracy_Value,notesTemplateValue,lastmodified_Date,lastSavedServer_Date,isLastEdited_Session,isSession_Modified,'null',createDayMonthYear(),createTime()),clickCount++,1==clickCount){var sessionwindow=r_miscue.tt.ui.createSessionWindow(usrname,session_Guid,user_Id,token,book_GUID,isSessionBookPage,menuItemKey,button_Id);sessionwindow.open(),bookTitleWind.remove(screenBackgroundImage[0]),screenBackgroundImage[0]=null,bookTitleWind.close()}tableView.removeEventListener('click',tableViewClickEvent)}Ti.API.info('coming to session book screen');var pWidth=Ti.Platform.displayCaps.platformWidth,db=Titanium.Database.open('Miscue'),homerow=db.execute('SELECT * FROM UserSetting where loginId =?',user_Id),schoolnames=homerow.fieldByName('schoolName'),backpage=homerow.fieldByName('backPage'),backcolour=homerow.fieldByName('backgroundColor'),fontcolour=homerow.fieldByName('fontColor'),pagefontfamily=homerow.fieldByName('charFont'),bookWindowBackgroundImage=homerow.fieldByName('selectionPagebackgroundURL'),dec=Ti.Utils.base64decode(schoolnames),backView=r_loadingScreen.createBackButton(fontcolour,homerow.fieldByName('backImageURL'));homerow.close(),homerow=null,db.close(),db=null;var iOS7=r_loadingScreen.isiOS7Plus(),bookTitleWind=Ti.UI.createWindow({fullscreen:!0,navBarHidden:!0,backgroundColor:'white'}),Inch=r_loadingScreen.screenInch(),screenBackgroundImage=r_loadingScreen.mainBackgroundImage(bookWindowBackgroundImage),osname=Ti.Platform.osname,screenRes=r_loadingScreen.backgroundImageHeightWidthPxToDp();screenBackgroundImage[1].height='iphone'==osname||'ipad'==osname?Titanium.Platform.displayCaps.platformHeight:Titanium.Platform.displayCaps.platformHeight/(Titanium.Platform.displayCaps.dpi/120),screenBackgroundImage[1].width=screenRes[0],Ti.Platform.displayCaps.platformWidth>Ti.Platform.displayCaps.platformHeight?(backView.height=70,backView.width=135,screenBackgroundImage[1].height=screenRes[1],Ti.API.info('Initial height for landscape '+screenBackgroundImage[1].height)):('ipad'==osname||'iphone'==osname?(screenBackgroundImage[1].height=Titanium.Platform.displayCaps.platformHeight-Titanium.Platform.displayCaps.platformHeight/2.5,Ti.API.info('Initial height for portrait ipad and iPhone '+screenBackgroundImage[1].height)):(screenBackgroundImage[1].height=Titanium.Platform.displayCaps.platformHeight/(Titanium.Platform.displayCaps.dpi/120),Ti.API.info('Initial height for portrait android'+screenBackgroundImage[1].height)),Inch>=InchValue&&('iphone'==osname||'ipad'==osname?(screenBackgroundImage[1].height=Titanium.Platform.displayCaps.platformHeight,Ti.API.info('Inch Height for iphone or ipad(portrait)'+screenBackgroundImage[1].height)):(screenBackgroundImage[1].height=Titanium.Platform.displayCaps.platformHeight/(Titanium.Platform.displayCaps.dpi/100),Ti.API.info('Inch Height for android(portrait)'+screenBackgroundImage[1].height)),backView.height=80,backView.width=145)),bookTitleWind.add(screenBackgroundImage[0]),7<=iOS7&&(bookTitleWind.top='20dp'),'iphone'==osname&&(backView.height=48,backView.width=78),Inch<InchValue&&'android'==osname?(backView.height=50,backView.width=80,bookTitleWind.orientationModes=[Titanium.UI.PORTRAIT]):'android'==osname&&(bookTitleWind.orientationModes=[Titanium.UI.PORTRAIT]),Ti.Gesture.addEventListener('orientationchange',orientionChangeMode);var top=r_loadingScreen.titleLabeltop();backView.addEventListener('click',function(e){tableView.removeEventListener('click',tableViewClickEvent),bookTitleWind.remove(selectBookLabel),tableView.removeAllChildren(),bookTitleWind.remove(backView),bookTitleWind.remove(tableView),bookTitleWind.remove(screenBackgroundImage[0]),screenBackgroundImage[0]=null,selectBookLabel=null,backView=null,tableView=null,iOS7=null;var learnerwindow=r_miscue.tt.ui.createLearnerWindow(usrname,groupname,token,button_Id,user_Id,menuItemKey);learnerwindow.open(),bookTitleWind.close(),bookTitleWind=null}),'android'==Ti.Platform.osname&&bookTitleWind.addEventListener('android:back',function(){tableView.removeEventListener('click',tableViewClickEvent),bookTitleWind.remove(selectBookLabel),tableView.removeAllChildren(),bookTitleWind.remove(backView),bookTitleWind.remove(tableView),bookTitleWind.remove(screenBackgroundImage[0]),screenBackgroundImage[0]=null,selectBookLabel=null,backView=null,tableView=null;var learnerwindow=r_miscue.tt.ui.createLearnerWindow(usrname,groupname,token,button_Id,user_Id,menuItemKey);learnerwindow.open(),bookTitleWind.close(),bookTitleWind=null});var selectBookLabel=Ti.UI.createLabel({color:fontcolour,top:'5%',width:'100%',font:{fontSize:Inch>=InchValue?'28dp':'18dp',fontWeight:'bold',fontFamily:pagefontfamily},textAlign:'center',text:'SELECT BOOK',touchEnabled:!1}),tableView=Ti.UI.createTableView(r_miscue.tt.combine(r_styles.$$.TableView,{top:top[2],separatorColor:'transparent',backgroundColor:'transparent',left:'5%',right:'5%'}));bookTitleWind.add(selectBookLabel),bookTitleWind.add(backView),bookTitleWind.add(tableView),bookTitleWind.addEventListener('close',function(e){Ti.Gesture.removeEventListener('orientationchange',orientionChangeMode)});var db=Titanium.Database.open('Miscue'),holddatavar=db.execute('SELECT * FROM UserBook WHERE userId = ? AND deleted = ?',user_Id,'no');if(tvData=[],'iphone'==osname||'ipad'==osname){var footerView=Ti.UI.createView({height:0});tableView.footerView=footerView,tableView.footerTitle=''}for(var bookname,i=0;i<holddatavar.rowCount;i++){bookname=holddatavar.fieldByName('bookName'),bookname=bookname.replace(/&quot;/gi,'\'');var bookguid=holddatavar.fieldByName('bookGuid'),bkImage=holddatavar.fieldByName('bookImage');Ti.API.log('bookname sessionBookPage.js called :: ',bookname),Ti.API.log('bookguid sessionBookPage.js called :: ',bookguid),Ti.API.log('bookImage sessionBookPage.js called :: ',bookImage);var row=Ti.UI.createTableViewRow(r_miscue.tt.combine(r_styles.$$.TableViewRow,{height:top[3],id:bookguid}));spacing='8dp',imgDimensions=top[4];var thisView=Ti.UI.createView({backgroundColor:'transparent',bottom:'1dp',left:spacing,height:Ti.UI.FILL,width:Inch>=InchValue||'ipad'==osname?'250dp':'120dp'}),bookImage=Ti.UI.createImageView({backgroundColor:'transparent',left:'0dp',defaultImage:'/images/phase5/NOBOOKIMAGE.png',bottom:'1dp',height:Ti.UI.SIZE,width:Ti.UI.SIZE,image:bkImage}),bookLabel=Ti.UI.createLabel(r_miscue.tt.combine(r_styles.$$.boldHeaderText,{text:bookname,left:'50%',color:fontcolour,font:{fontSize:Inch>=InchValue?'28dp':'18dp',fontWeight:'bold',fontFamily:pagefontfamily}})),separatorLine=Ti.UI.createView({bottom:'1%',backgroundColor:'#A9A9A9',height:'3dp',width:'100%'});thisView.add(bookImage),row.add(bookLabel),row.add(thisView),row.add(separatorLine),tvData.push(row),holddatavar.next()}holddatavar.close(),db.close(),tableView.setData(tvData);var clickCount=0,dayNames=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'],monthNames=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];return tableView.addEventListener('click',tableViewClickEvent),bookTitleWind}})();var r_miscueSesionPage=require('/MainMiscue/ui/miscueSessionPage.js');function createDate(){var lastSavedServerDate=new Date,lastSavedServerDate=lastSavedServerDate.toISOString();return lastSavedServerDate}exports.createDate=createDate;function createSavePendingMiscueSessionToServer(xmlSync,userId,sessionGuid,closeWindow,apiCount,sessionCount,token,HomeMenuItemKey,fontcolour,backcolour,pagefontfamily,isPageName,tableView,userName,loopEnds,submitSession){var docData=Ti.XML.parseString(xmlSync),responses=docData.getElementsByTagName('response'),responseResult=responses.item(0).getElementsByTagName('result').item(0).textContent;if('REQUEST_OK'==responseResult){var db=Titanium.Database.open('Miscue'),audioFileExistCheckRow=db.execute('SELECT * FROM MiscueSession  WHERE userId = ? AND sessionGuid = ? AND sessionStatus = ?',userId,sessionGuid,'DELETED');if(0<audioFileExistCheckRow.rowCount){var file=audioFileExistCheckRow.fieldByName('recordedAudioFilename');if('null'!=file){if('android'!=Ti.Platform.osname)file=Titanium.Filesystem.getFile(Ti.Filesystem.tempDirectory,file);else{var audioDir=Titanium.Filesystem.getFile(Titanium.Filesystem.externalStorageDirectory,'Miscue');file=Ti.Filesystem.getFile(audioDir.resolve(),file)}file.deleteFile()}}audioFileExistCheckRow.close(),db.execute('DELETE FROM MiscueSession WHERE userId = ? AND sessionGuid = ? AND sessionStatus = ?',userId,sessionGuid,'DELETED'),db.execute('UPDATE MiscueSession SET lastSavedToServerDate = ? WHERE userId = ? AND sessionGuid = ?',createDate(),userId,sessionGuid),db.close(),'searchSession'!=isPageName&&r_loadingScreen.hideActivity(),closeWindow.touchEnabled=!0,'searchSession'==isPageName&&apiCount==sessionCount&&(submitSession.visible=!1,closeWindow.remove(tableView),r_searchSession.createSearchFeild(tableView,userId,closeWindow,userName,token,HomeMenuItemKey,fontcolour,backcolour,pagefontfamily),r_loadingScreen.hideActivity())}else if('REQUEST_FAIL'==responseResult){if('true'==loopEnds){var responseResults=docData.getElementsByTagName('response').item(0).text;49<responseResults.length&&(responseResults=responseResults.substring(49,responseResults.length));var dialog=Ti.UI.createAlertDialog({buttonNames:['Ok'],message:'Failed to save miscue session on server. Please try later from miscue search page. Server Response:\n'+responseResults,title:'Warning'});dialog.show(),dialog.addEventListener('click',function(e){0==e.index&&('searchSession'!=isPageName&&r_loadingScreen.hideActivity(),closeWindow.touchEnabled=!0,'searchSession'==isPageName&&apiCount==sessionCount&&(closeWindow.remove(tableView),r_searchSession.createSearchFeild(tableView,userId,closeWindow,userName,token,HomeMenuItemKey,fontcolour,backcolour,pagefontfamily),r_loadingScreen.hideActivity()))})}}else if(1==apiCount){var db=Titanium.Database.open('Miscue'),grouploginrow=db.execute('SELECT * FROM Login  WHERE userid=?',userId),groupuserName=grouploginrow.fieldByName('username');grouploginrow.close(),db.close();var error=docData.getElementsByTagName('error'),message=error.item(0).getElementsByTagName('message').item(0).textContent,labelArray=[];labelArray.title=['Alert','Alert'],labelArray.message=['invalid_Session_Message',message],labelArray[1]=['Ok','OK'];var dialog=r_HomeScreen.createLocalizedAlertDialog(labelArray,groupuserName);dialog.show(),dialog.addEventListener('click',function(e){if(0==e.index&&'Invalid or expired session ID'==message){var db=Titanium.Database.open('Miscue');db.execute('UPDATE Login SET logoutFlag=? WHERE userid=?',2,userId),db.close();var loginWin=r_miscue.tt.ui.createLoginPage();loginWin.open(),closeWindow.close()}})}}exports.createSavePendingMiscueSessionToServer=createSavePendingMiscueSessionToServer;function SaveMiscueSessionToServer(xmlSync,userId,sessionGuid,sessionWindow,userName,menuItemKey,token){var docData=Ti.XML.parseString(xmlSync),responses=docData.getElementsByTagName('response'),responseResult=responses.item(0).getElementsByTagName('result').item(0).textContent;if('REQUEST_OK'==responseResult){Ti.App.Properties.setString('offline','false');var db=Titanium.Database.open('Miscue'),audioFileExistCheckRow=db.execute('SELECT * FROM MiscueSession  WHERE userId = ? AND sessionGuid = ? AND sessionStatus = ?',userId,sessionGuid,'DELETED');if(0<audioFileExistCheckRow.rowCount){var file=audioFileExistCheckRow.fieldByName('recordedAudioFilename');if('null'!=file){if('android'!=Ti.Platform.osname)file=Titanium.Filesystem.getFile(Ti.Filesystem.tempDirectory,file);else{var audioDir=Titanium.Filesystem.getFile(Titanium.Filesystem.externalStorageDirectory,'Miscue');file=Ti.Filesystem.getFile(audioDir.resolve(),file)}file.deleteFile()}}if(audioFileExistCheckRow.close(),db.execute('DELETE FROM MiscueSession WHERE userId = ? AND sessionGuid = ? AND sessionStatus = ?',userId,sessionGuid,'DELETED'),db.execute('UPDATE MiscueSession SET lastSavedToServerDate = ? WHERE userId = ? AND sessionGuid = ?',createDate(),userId,sessionGuid),db.close(),'book'==menuItemKey){r_loadingScreen.hideActivity();var menuItemKeys='miscueanalysis',miscuewindow=r_miscue.tt.ui.createmiscueMenuPage(userName,token,menuItemKeys);miscuewindow.open(),sessionWindow.close()}else if('search'==menuItemKey){r_loadingScreen.hideActivity();var menuItemKeys='miscueanalysis',searchSession=r_miscue.tt.ui.createsearchSession(userName,userId,token,menuItemKeys);searchSession.open(),sessionWindow.close()}}else if('REQUEST_OK'!=responseResult){var responseResults=docData.getElementsByTagName('response').item(0).textContent;49<responseResults.length&&(responseResults=responseResults.substring(49,responseResults.length));var dialog=Ti.UI.createAlertDialog({buttonNames:['Ok'],message:'Failed to save miscue session on server. Please try later from miscue search page. Server Response:\n'+responseResults,title:'Warning'});dialog.show(),dialog.addEventListener('click',function(e){if(0==e.index)if(r_loadingScreen.hideActivity(),'book'==menuItemKey){var menuItemKeys='miscueanalysis',miscuewindow=r_miscue.tt.ui.createmiscueMenuPage(userName,token,menuItemKeys);miscuewindow.open(),sessionWindow.close()}else if('search'==menuItemKey){var menuItemKeys='miscueanalysis',searchSession=r_miscue.tt.ui.createsearchSession(userName,userId,token,menuItemKeys);searchSession.open(),sessionWindow.close()}})}}exports.SaveMiscueSessionToServer=SaveMiscueSessionToServer;