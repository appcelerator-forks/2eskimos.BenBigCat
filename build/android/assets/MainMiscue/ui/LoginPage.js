var r_styles=require('/MainMiscue/ui/styles'),r_Apifile=require('/MainMiscue/ui/Apifile'),r_Miscuedb=require('/MainMiscue/model/Miscuedb'),r_miscue=require('/MainMiscue/miscue.js'),r_loadingScreen=require('/MainMiscue/ui/loadingScreen');(function(){r_miscue.tt.ui.createLoginPage=function(_args){function GetHeight(value){var temp=100*value/480;return parseInt(Ti.Platform.displayCaps.platformHeight*temp/100)}function orientationChangeMode(){pWidth=Ti.Platform.displayCaps.platformWidth,pHeight=Ti.Platform.displayCaps.platformHeight,loginBackgroundImage.center='android'==osname?{x:Ti.Platform.displayCaps.platformWidth/(Titanium.Platform.displayCaps.dpi/160)/2,y:Ti.Platform.displayCaps.platformHeight/(Titanium.Platform.displayCaps.dpi/160)/2}:{x:Ti.Platform.displayCaps.platformWidth/2,y:Ti.Platform.displayCaps.platformHeight/2};var screenRes=r_loadingScreen.backgroundImageHeightWidthPxToDp();loginBackgroundImage.height=screenRes[1],loginBackgroundImage.width=screenRes[0],Ti.Platform.displayCaps.platformHeight<Ti.Platform.displayCaps.platformWidth?Inch>=InchValue||'ipad'==osname?(Ti.API.info('do not vome hete'),registrationButton.font={fontSize:'26dp'},'android'!=osname&&(container.height=pHeight,container.width=pWidth,registrationButton.font={fontSize:'34dp'}),userNameView.bottom='android'==osname?'40%':'38%',userNameView.left='32%',userNameView.right='32%',userNameView.height='android'==osname?'50dp':'60dp',leftUserIcon.height='android'==osname?'25dp':'30dp',leftUserIcon.width='android'==osname?'25dp':'30dp',leftPadlockIcon.height='android'==osname?'25dp':'30dp',leftPadlockIcon.width='android'==osname?'25dp':'30dp',usrName.left='15%',usrName.font={fontSize:'22dp'},psw.left='15%',psw.font={fontSize:'22dp'},passwordView.bottom='android'==osname?'29%':'28%',passwordView.left='32%',passwordView.right='32%',passwordView.height='android'==osname?'50dp':'60dp',remember.bottom='21%',remember.left='36.5%',typeCheckBox.bottom='21%',typeCheckBox.left=Inch>=InchValue?'32%':'18%',loginButton.bottom='13%',loginButton.right=Inch>=InchValue?'32%':'18%',loginButton.height='50dp',registrationButton.bottom=Inch>=InchValue?'3%':'1%','android'==osname&&(loginButton.height='35dp',loginButton.bottom='11%',registrationButton.bottom=' 1%',typeCheckBox.height='25dp',typeCheckBox.bottom='17%',remember.bottom='17%',remember.font={fontSize:'20dp'},passwordView.bottom='24.5%',userNameView.bottom='35.5%'),'ipad'==osname&&(typeCheckBox.left=Inch>=InchValue?'32%':'32%',loginButton.right=Inch>=InchValue?'32%':'32%')):Ti.API.info('come here'):(registrationButton.font={fontSize:Inch>=InchValue?'44dp':'28dp'},'android'==osname&&(registrationButton.font={fontSize:'28dp'}),'android'!=osname&&(container.height=pHeight,container.width=pWidth),userNameView.bottom=Inch>=InchValue?'37%':'38%','ipad'==osname&&(userNameView.bottom='36%'),userNameView.left=Inch>=InchValue?'28%':'18%',userNameView.right=Inch>=InchValue?'28%':'18%',userNameView.height='android'==osname?Inch>=InchValue?'65dp':Titanium.UI.SIZE:Inch>=InchValue?'65dp':'35dp',leftUserIcon.height=Inch>=InchValue?'30dp':'15dp',leftUserIcon.width=Inch>=InchValue?'30dp':'15dp',leftPadlockIcon.height=Inch>=InchValue?'30dp':'15dp',leftPadlockIcon.width=Inch>=InchValue?'30dp':'15dp',usrName.left=Inch>=InchValue?'15%':'15%',psw.left=Inch>=InchValue?'15%':'15%',usrName.font={fontSize:Inch>=InchValue?'26dp':'18dp'},psw.font={fontSize:Inch>=InchValue?'26dp':'18dp'},passwordView.bottom='28%',passwordView.left=Inch>=InchValue?'28%':'18%',passwordView.right=Inch>=InchValue?'28%':'18%',passwordView.height='android'==osname?Inch>=InchValue?'65dp':Titanium.UI.SIZE:Inch>=InchValue?'65dp':'35dp',remember.bottom=Inch>=InchValue?'22%':'21.5%',remember.left=Inch>=InchValue?'34%':'25%',remember.font={fontSize:Inch>=InchValue?'26dp':'15dp'},typeCheckBox.bottom='22%',typeCheckBox.left=Inch>=InchValue?'28%':'18%',typeCheckBox.height=Inch>=InchValue?'35dp':'15dp',loginButton.bottom='14%',loginButton.right=Inch>=InchValue?'28%':'18%',loginButton.height=Inch>=InchValue?'50dp':'30dp',registrationButton.bottom=Inch>=InchValue?'3%':'1%','android'==osname&&Inch<InchValue&&(loginButton.bottom='11.5%',typeCheckBox.bottom='19.5%',remember.bottom='19%',passwordView.bottom='25.5%',userNameView.bottom='35.5%'))}function getOrientation(orientVal){var value;return value=1===orientVal?1:4===orientVal?2:2===orientVal?3:3===orientVal?4:0,value}function orientionChangeMode(e){return;var orientVal=e.source.orientation,orientationVal=getOrientation(orientVal);orientationVal!=orientCount&&0!=orientationVal&&orientationChangeMode()}var username,password,cookie=null,osname=Ti.Platform.osname,db=Titanium.Database.open('Miscue'),usrcach='User Name',cacherow=db.execute('SELECT * FROM Login WHERE cachevalue=?',1);if(1<=cacherow.rowCount)var usrcach=cacherow.fieldByName('username');cacherow.close(),db.close();var pWidth=Ti.Platform.displayCaps.platformWidth,pHeight=Ti.Platform.displayCaps.platformHeight,devicemodel=Titanium.Platform.model,devosversion=Titanium.Platform.version,deviceinstalid=Ti.Platform.createUUID(),db=Titanium.Database.open('Miscue'),deviceidrow=db.execute('SELECT * FROM DeviceID');0==deviceidrow.rowCount?(db.close(),r_Miscuedb.insertDeviceinstalID(deviceinstalid)):db.close(),deviceidrow.close();var loginWin=Ti.UI.createWindow({fullscreen:!1,navBarHidden:!0,exitOnClose:!0,backgroundColor:'white',tabBarHidden:!0,height:'100%',width:'100%',titleControl:!1});Ti.App.Properties.setString('isConvertedToDP','true');var Inch=r_loadingScreen.screenInch();Inch<InchValue&&'android'==osname?loginWin.orientationModes=[Titanium.UI.PORTRAIT]:Inch>=InchValue&&'android'==osname&&(loginWin.orientationModes=[Titanium.UI.PORTRAIT]);var loginBackgroundImageView=Ti.UI.createView({backgroundColor:'transparent',height:Titanium.UI.FILL,width:Titanium.UI.FILL}),loginBackgroundImage=Ti.UI.createImageView({top:'0dp',backgroundColor:'#D8E028',center:{x:Ti.Platform.displayCaps.platformWidth/(Titanium.Platform.displayCaps.dpi/160)/2,y:Ti.Platform.displayCaps.platformHeight/(Titanium.Platform.displayCaps.dpi/160)/2}});'android'==osname&&(loginWin.add(loginBackgroundImageView),loginBackgroundImageView.add(loginBackgroundImage));var screenRes=r_loadingScreen.backgroundImageHeightWidthPxToDp();loginBackgroundImage.height=screenRes[1],loginBackgroundImage.width=screenRes[0];var scrollView=Ti.UI.createScrollView({contentHeight:'auto',showVerticalScrollIndicator:!0,showHorizontalScrollIndicator:!0,height:'auto',width:'auto',backgroundColor:'transparent'}),container=Ti.UI.createView({backgroundColor:'transparent',top:'1dp'}),userNameView=Ti.UI.createView({backgroundColor:'black',opacity:0.3,borderWidth:'2dp',borderColor:'#aaa',borderRadius:8,height:100}),leftUserIcon=Titanium.UI.createButton({backgroundImage:'/images/userIcon.png',left:'3%',opacity:0.3}),usrName=Ti.UI.createTextField({backgroundColor:'transparent',value:usrcach,returnKeyType:Titanium.UI.RETURNKEY_NEXT,autocapitalization:Titanium.UI.TEXT_AUTOCAPITALIZATION_NONE,color:'white',height:Titanium.UI.FILL,right:0,focusable:!0,height:50});userNameView.add(usrName),userNameView.add(leftUserIcon);var passwordView=Ti.UI.createView({backgroundColor:'black',opacity:0.3,borderWidth:'2dp',borderColor:'#aaa',borderRadius:8,height:50}),leftPadlockIcon=Titanium.UI.createButton({backgroundImage:'/images/padlockIcon.png',left:'3%',opacity:0.3}),psw=Ti.UI.createTextField({returnKeyType:Titanium.UI.RETURNKEY_DONE,autocapitalization:Titanium.UI.TEXT_AUTOCAPITALIZATION_NONE,backgroundColor:'transparent',color:'white',height:Titanium.UI.FILL,right:0,height:50});passwordView.add(psw),passwordView.add(leftPadlockIcon);var newUsrName,newPsw;'android'==Ti.Platform.name&&23>Ti.Platform.Android.API_LEVEL&&(newUsrName=Ti.UI.createTextField({backgroundColor:'transparent',text:usrName.value,color:'white',font:{fontSize:'30dp'},left:'35%',top:'56.5%',width:'35%',height:60,zIndex:100,textAlign:Titanium.UI.TEXT_ALIGNMENT_LEFT}),usrName.visible=!1,newUsrName.addEventListener('change',function(e){Ti.API.info('----------newUsrName text was changed!'),usrName.value=newUsrName.value}),newPsw=Ti.UI.createTextField({backgroundColor:'transparent',text:psw.value,color:'white',passwordMask:!0,font:{fontSize:'30dp'},left:'35%',top:'65.5%',width:'35%',height:60,zIndex:100,textAlign:Titanium.UI.TEXT_ALIGNMENT_LEFT}),newPsw.addEventListener('change',function(e){Ti.API.info('----------newPsw text was changed to = '+psw.value+'! Length = '+psw.value.length),psw.value=newPsw.value}),psw.visible=!1,container.add(newUsrName),container.add(newPsw)),usrName.addEventListener('focus',function(e){'User Name'==this.value&&(this.value='')}),usrName.addEventListener('blur',function(e){this.value||(this.value='User Name')}),psw.addEventListener('focus',function(e){'Password'==this.value&&(this.value='',psw.passwordMask=!0)}),psw.addEventListener('blur',function(e){this.value||(this.value='Password',this.passwordMask=!1)}),leftUserIcon.addEventListener('click',function(e){usrName.focus(),'android'==osname&&(usrName.softKeyboardOnFocus=Ti.UI.Android.SOFT_KEYBOARD_SHOW_ON_FOCUS)}),leftPadlockIcon.addEventListener('click',function(e){psw.focus(),'android'==osname&&(psw.softKeyboardOnFocus=Ti.UI.Android.SOFT_KEYBOARD_SHOW_ON_FOCUS)}),'iPhone OS'==Ti.Platform.name&&usrName.addEventListener('return',function(){usrName.blur(),psw.focus()});var loginButton=Ti.UI.createButton(r_miscue.tt.combine(r_styles.$$.Button,{width:'95dp',style:Titanium.UI.iPhone.SystemButtonStyle.BORDERED,backgroundColor:'black',my_id:'login_loginbutton',opacity:0.3,borderRadius:5,font:{fontSize:Inch>=InchValue?'26dp':'15dp'}})),remember=Ti.UI.createLabel({color:'white',width:'200dp',font:{fontSize:Inch>=InchValue?'26dp':'15dp'},my_id:'login_remember',touchEnabled:!1}),typeCheckBox=Titanium.UI.createImageView({image:'/images/unchecked.png',width:Inch>=InchValue?'35dp':'15dp',height:Inch>=InchValue?'35dp':'15dp',backgroundColor:'black',opacity:0.3}),registrationButton=Ti.UI.createButton(r_miscue.tt.combine(r_styles.$$.boldHeaderText,{color:Inch>=InchValue?'#88609B':'#88609B',width:'100%',height:'40dp',font:{fontFamily:'Helvetica Neue',fontSize:Inch>=InchValue?'84dp':'58dp',fontWeight:'bold'},backgroundColor:'white',style:Titanium.UI.iPhone.SystemButtonStyle.BORDERED,my_id:'login_register',textAlign:Titanium.UI.TEXT_ALIGNMENT_CENTER})),version=Ti.UI.createLabel({color:'lightgray',width:'200dp',font:{fontSize:Inch>=InchValue?'26dp':'12dp'},my_id:'version_number',touchEnabled:!1});if('User Name'!=usrName.value){var db=Titanium.Database.open('Miscue'),loginInfoRow=db.execute('SELECT * FROM Login where username =?',usrName.value),loginUserId=loginInfoRow.fieldByName('userid');loginInfoRow.close(),loginInfoRow=null;var userSettingRow=db.execute('SELECT * FROM UserSetting where loginId =?',loginUserId),loginBackImage='/images/V1.9/LOGIN_BG.png';''==loginBackImage?Inch<InchValue||'ipad'==osname:loginBackgroundImage.image=loginBackImage,userSettingRow.close(),userSettingRow=null,db.close(),db=null}else Inch<InchValue||'ipad'==osname;loginBackgroundImage.image='/images/V1.9/LOGIN_BG.png';var xCenterValue;orientationChangeMode();var orientCount=6;Ti.Gesture.addEventListener('orientationchange',orientionChangeMode),loginWin.addEventListener('close',function(e){usrName.removeEventListener('focus',function(e){}),usrName.removeEventListener('blur',function(e){}),psw.removeEventListener('focus',function(e){}),psw.removeEventListener('blur',function(e){}),leftPadlockIcon.removeEventListener('click',function(e){}),leftUserIcon.removeEventListener('click',function(e){}),Ti.Gesture.removeEventListener('orientationchange',orientionChangeMode),userNameView.remove(usrName),passwordView.remove(psw),container.remove(userNameView),container.remove(passwordView),container.remove(loginButton),container.remove(typeCheckBox),container.remove(remember),container.remove(registrationButton),container.remove(version),loginBackgroundImageView.remove(loginBackgroundImage),loginWin.remove(loginBackgroundImageView),'android'==osname?loginWin.remove(container):(scrollView.remove(container),loginWin.remove(scrollView)),usrName=null,psw=null,userNameView=null,passwordView=null,loginBackgroundImageView=null,loginBackgroundImage=null,loginButton=null,typeCheckBox=null,remember=null,registrationButton=null,version=null,container=null,scrollView=null}),typeCheckBox.addEventListener('click',function(e){var val;'/images/unchecked.png'==typeCheckBox.image?(typeCheckBox.image='/images/checked.png',val=1):(typeCheckBox.image='/images/unchecked.png',val=0)}),'android'!=osname&&container.add(loginBackgroundImage),container.add(remember),container.add(typeCheckBox),container.add(userNameView),container.add(passwordView),container.add(loginButton),'1'==Ti.App.Properties.getString('registerLink')&&container.add(registrationButton),container.add(version),'android'==osname?loginWin.add(container):(scrollView.add(container),loginWin.add(scrollView)),usrName.addEventListener('change',function(e){validLogs=!1;for(var db=Titanium.Database.open('Miscue'),textchange=db.execute('SELECT * FROM Login');textchange.isValidRow();){var user_name=textchange.fieldByName('username'),user_checkval=textchange.fieldByName('checkvalue');if(user_name==usrName.value&&1==user_checkval){var changeName=usrName.value;validLogs=!0;var user_pas=textchange.fieldByName('getP');break}textchange.next()}if(!0==validLogs){psw.passwordMask=!0,typeCheckBox.image='/images/checked.png';passwordMask:!0;psw.value=user_pas}else!1==validLogs&&(typeCheckBox.image='/images/unchecked.png',''!=usrName.value&&'User Name'!=usrName.value&&(psw.passwordMask=!1,psw.value='Password'));db.close()});var db=Titanium.Database.open('Miscue'),cachcheck=db.execute('SELECT * FROM Login WHERE cachevalue=?',1);if(1<=cachcheck.rowCount)var chkvalue=cachcheck.fieldByName('username');if(1<=cachcheck.rowCount){cachcheck.close();var chkrows=db.execute('SELECT * FROM Login WHERE username=?',usrName.value);if(1<=chkrows.rowCount)var chkvalue=chkrows.fieldByName('checkvalue'),pwd=chkrows.fieldByName('getP');chkrows.close()}db.close(),typeCheckBox.image='/images/unchecked.png',psw.value='Password',1==chkvalue&&(psw.passwordMask=!0,typeCheckBox.image='/images/checked.png',psw.value=pwd);var db=Titanium.Database.open('Miscue');if('User Name'==usrName.value)loginButton.title='Login',remember.text='Remember me',registrationButton.title='Get started';else{var login_flag='true',refer_Language=db.execute('SELECT * FROM Language WHERE isLastUsedLang = ?',login_flag);if(0<refer_Language.rowCount)for(;refer_Language.isValidRow();){var langparamPosId=refer_Language.fieldByName('labelId'),langparamPosValue=refer_Language.fieldByName('label');switch(langparamPosId){case'login_loginbutton':loginButton.title=langparamPosValue;break;case'login_remember':remember.text=langparamPosValue;break;case'login_register':registrationButton.title=langparamPosValue;break;default:}refer_Language.next()}else loginButton.title='Login',remember.text='Remember me',registrationButton.title='Get started'}return db.close(),version.text=Titanium.App.version,version.left='85%',version.bottom=' 1%',loginButton.addEventListener('click',function(){if(usrName.blur(),psw.blur(),loginWin.touchEnabled=!1,!Ti.Network.online){var validLog=!1;if('User Name'==usrName.value&&'Password'==psw.value||''==usrName.value&&''==psw.value||''==usrName.value&&'Password'==psw.value||'User Name'==usrName.value&&''==psw.value)loginWin.touchEnabled=!0,alert('Please enter UserId and password');else{for(var db=Titanium.Database.open('Miscue'),holddatavar=db.execute('SELECT * FROM Login');holddatavar.isValidRow();){var app_name=holddatavar.fieldByName('username'),app_psw=holddatavar.fieldByName('getP');if(app_name==usrName.value&&app_psw==psw.value){var offlineusername=usrName.value;validLog=!0;break}holddatavar.next()}holddatavar.close();var holddatavar1=db.execute('SELECT * FROM Login');if(1<=holddatavar1.rowCount)for(var cachid,cachig=0;holddatavar1.isValidRow();)cachid=holddatavar1.fieldByName('userid'),db.execute('UPDATE Login SET cachevalue=? WHERE userid=? AND cachevalue = ?',cachig,cachid,1),holddatavar1.next();if(holddatavar1.close(),db.close(),'/images/checked.png'==typeCheckBox.image?val=1:'/images/unchecked.png'==typeCheckBox.image&&(val=0),!0==validLog){var db=Titanium.Database.open('Miscue'),sessioncheck=db.execute('SELECT * FROM Login');0<sessioncheck.rowCount&&db.execute('UPDATE Login SET logoutFlag=? WHERE username=?',1,usrName.value),sessioncheck.close();var logcach=db.execute('SELECT * FROM Login WHERE username =?',offlineusername);if(1<=logcach.rowCount){var labelArray=[];labelArray.message=['loading_Indicator','Loading...'],r_loadingScreen.showActivity(labelArray.message,usrName.value);var cachval=1,cachlogid=logcach.fieldByName('userid');db.execute('UPDATE Login SET cachevalue=?,checkvalue=? WHERE userid=?',cachval,val,cachlogid);var cachidss=logcach.fieldByName('cachevalue')}logcach.close(),db.execute('UPDATE UserSetting SET islastUsedBrandLogo=? ','false');var flag='false',languageRow=db.execute('SELECT * FROM Language');if(0<languageRow.rowCount)for(;languageRow.isValidRow();)db.execute('UPDATE Language SET isLastUsedLang=?',flag),languageRow.next();languageRow.close(),db.close();var w1=r_miscue.tt.ui.createHomeScreen(offlineusername);w1.open(),loginWin.close()}else{loginWin.touchEnabled=!0;var labelArray=[];labelArray.title=['Alert','Alert'],labelArray.message=['offline_Invalid_Login_Message','You are not connected to the internet. Please connect to internet and try again'],labelArray[1]=['Ok','Ok'];var dialog=r_HomeScreen.createLocalizedAlertDialog(labelArray,usrName.value);dialog.show(),typeCheckBox.image='/images/unchecked.png',psw.value='','/images/checked.png'==typeCheckBox.image&&(typeCheckBox.image='/images/unchecked.png')}}}else if('User Name'!=usrName.value&&'Password'!=psw.value||''!=usrName.value&&''!=psw.value||''!=usrName.value&&'Password'!=psw.value||'User Name'!=usrName.value&&''!=psw.value){var message,db=Titanium.Database.open('Miscue'),labelArray=[];labelArray.message=['loading_Indicator','Loading...'],r_loadingScreen.showActivity(labelArray.message,usrName.value);var base_URL='https://www.miscue.co.uk/iglooapi/apirequest.aspx',URL1='http://mahitiin.pairserver.com/demo/miscue/login.php';username=usrName.value,'*'==username.substring(0,1)?(username=username.substring(1,99),Ti.App.Properties.setString('apiURL',Ti.App.Properties.getString('apiTestURL')),alert('Using API: '+Ti.App.Properties.getString('apiURL'))):Ti.App.Properties.setString('apiURL',Ti.App.Properties.getString('apiLiveURL')),password=psw.value;var username1=username.substring(username.length-2,username.length),urltesting=-1==username1||-2==username1||-3==username1?URL1:base_URL;Ti.API.info('-------- urltesting = '+urltesting),(-1==username1||-2==username1||-3==username1)&&(username=username1.substring(1,username1.length));var db=Titanium.Database.open('Miscue'),devcidrow=db.execute('SELECT * FROM DeviceID'),InputdeviceID=devcidrow.fieldByName('DeviceInstallID');db.close(),devcidrow.close();var devicedpi=Ti.Platform.displayCaps.dpi,deviceOs=Ti.Platform.osname,deviceHorizontalRes=Ti.Platform.displayCaps.platformWidth,deviceVerticalRes=Ti.Platform.displayCaps.platformHeight,str1='<request><requesttype>LOGIN</requesttype><userID>'+username+'</userID><pwd>'+password+'</pwd><deviceinstallid>'+InputdeviceID+'</deviceinstallid><devicemodel>'+devicemodel+'</devicemodel><deviceosversion>'+devosversion+'</deviceosversion><devicehres>'+deviceHorizontalRes+'</devicehres><devicevres>'+deviceVerticalRes+'</devicevres><devicedpi>'+devicedpi+'</devicedpi><deviceos>'+deviceOs+'</deviceos></request>';'/images/checked.png'==typeCheckBox.image?val=1:'/images/unchecked.png'==typeCheckBox.image&&(val=0);var flag=1,apifile=r_Apifile.createApi(urltesting,str1,username,password,flag,loginWin,val);loginWin.touchEnabled=!0}else{var labelArray=[];labelArray.title=['Alert','Alert'],labelArray.message=['Empty_Login_Field_Message','Please enter UserId and password'],labelArray[1]=['Ok','Ok'];var dialog=r_HomeScreen.createLocalizedAlertDialog(labelArray,usrName.value);dialog.show(),loginWin.touchEnabled=!0}}),registrationButton.addEventListener('click',function(){if(Ti.Network.online){var tweetWindow=Titanium.UI.createWindow({height:'80%',width:'80%',backgroundColor:'white',borderWidth:'3dp',borderColor:'black',layout:'vertical',navBarHidden:!0,opacity:1}),closeButton=Ti.UI.createImageView({title:'Close',backgroundColor:'white',height:'30dp',width:'30dp',image:'/images/close.png',right:'1dp',style:Titanium.UI.iPhone.SystemButtonStyle.BORDERED,top:0});closeButton.addEventListener('click',function(){tweetWindow.close()});var webView=Titanium.UI.createWebView({top:0,url:Ti.App.Properties.getString('registerURL')});tweetWindow.add(closeButton),tweetWindow.add(webView),tweetWindow.open({modal:!1}),webView.addEventListener('load',function(e){var re=/(google.co.in\/imghp)/;!0==!!e.url.match(re)&&tweetWindow.close()})}else alert('An Internet connection is required for this')}),loginWin}})();function getLanguage(xmlSync,userName){var login_Flag='true',flag='false',db=Titanium.Database.open('Miscue'),language_row=db.execute('SELECT * FROM Language');if(1<language_row.rowCount)for(;language_row.isValidRow();)db.execute('UPDATE Language SET isLastUsedLang=?',flag),language_row.next();var homelog=db.execute('SELECT * FROM Login WHERE username =?',userName),uids=homelog.fieldByName('userid'),langCheck=db.execute('SELECT * FROM Language WHERE userId =?',userName),docData=Ti.XML.parseString(xmlSync),responses=docData.getElementsByTagName('response'),data=docData.getElementsByTagName('data'),result=docData.getElementsByTagName('result').item(0).text;if(0<langCheck.rowCount&&db.execute('DELETE FROM Language WHERE userId =?',userName),homelog.close(),langCheck.close(),db.close(),'GETLANGUAGE_OK'==result)for(var labelName,labelId,langCount=0,label=data.item(0).getElementsByTagName('label'),i=0;i<label.length;i++)labelName=data.item(0).getElementsByTagName('label').item(i).text,labelId=data.item(0).getElementsByTagName('label').item(i).getAttribute('id'),insertLanguage(labelId,labelName,userName,login_Flag)}exports.getLanguage=getLanguage;function callback(xmlSync,txt1,txt2,rememberMeCheckValue,loginWin){xmlSync=xmlSync.replace(/&/g,'&amp;'),xmlSync=xmlSync.replace(/'/g,'&apos;'),xmlSync=xmlSync.replace(/'/g,'&quot;');var docData=Ti.XML.parseString(xmlSync),responses=docData.getElementsByTagName('response'),apconf=docData.getElementsByTagName('appconfig'),menusitems=docData.getElementsByTagName('menuitem'),menus=docData.getElementsByTagName('menu'),menusitm=docData.getElementsByTagName('menus'),miscueMenu=docData.getElementsByTagName('Menu'),miscueTypes=docData.getElementsByTagName('MiscueTypes'),sql=docData.documentElement.getElementsByTagName('SQL').length,data=docData.getElementsByTagName('data'),result=responses.item(0).getElementsByTagName('result').item(0).textContent;if('LOGIN_FAIL'==result)var message=responses.item(0).getElementsByTagName('code').item(0).textContent;if(2==message){var errormsg=docData.getElementsByTagName('error'),errormessage=errormsg.item(0).getElementsByTagName('message').item(0).textContent;alert(errormessage);var txt1='user2',txt2='user2',db=Titanium.Database.open('Miscue'),databaseerror=db.execute('SELECT * FROM Login WHERE username = ? AND getP = ?',txt1,txt2)}if('LOGIN_OK'===result){var user=txt1,password=txt2,cachval=1,userlanguage='English',logoutflag=1;logoutflag=logoutflag.toString();var acstkn=data.item(0).getElementsByTagName('accesstoken').item(0).textContent;if(r_Miscuedb.insertLogin(user,password,rememberMeCheckValue,cachval,userlanguage,1,acstkn),0<apconf.length)for(var school,i=0;i<apconf.length;i++){school=apconf.item(i).getElementsByTagName('schoolname').item(0).textContent,Ti.API.info('school name at login page '+school),school=school.replace(/&apos;/gi,'\'');var backimage='/images/V1.9/MAIN_BG.png',backcolour=apconf.item(i).getElementsByTagName('backgroundcolor').item(0).textContent,lang=apconf.item(i).getElementsByTagName('primarylanguage'),miscueMenuPageBackgroundImage='/images/V1.9/MISCUEMENU_BG.png',homePageBackgroundImage='/images/V1.9/MAINMENU_BG.png',selectionPagebackgroundURL='/images/V1.9/MAIN_BG.png',sessionPagebackgroundURL='/images/V1.9/MAIN_BG.png',backImageURL='/images/V1.9/BACK_BUTTON.png',saveImageURL='/images/MISCUE_SAVE.png',logoutImageURL='/images/V1.9/LOGOUT.png';if(1<=lang.length){var languages=apconf.item(i).getElementsByTagName('primarylanguage').item(0).textContent;''==languages&&(languages='English')}else var languages='English';var db=Titanium.Database.open('Miscue'),updateid=db.execute('UPDATE Login SET userLanguage =? WHERE  username =?',languages,user),fontcolour=apconf.item(i).getElementsByTagName('color').item(0).textContent,charfont=apconf.item(i).getElementsByTagName('font').item(0).textContent,xmlLogo=apconf.item(i).getElementsByTagName('mainlogo').item(0).textContent,encr=Ti.Utils.base64encode(school),logrows=db.execute('SELECT * FROM Login  WHERE username=?',txt1),user_Login_id=logrows.fieldByName('userid');db.execute('UPDATE UserSetting SET islastUsedBrandLogo=?','false');var desrows=db.execute('SELECT * FROM UserSetting WHERE loginId=?',user_Login_id);1<=desrows.rowCount?(db.close(),r_Miscuedb.userSettingDelete(user_Login_id)):db.close();var islastUsedLogo='false';r_Miscuedb.insertUserSetting(encr,backcolour,fontcolour,charfont,backimage,xmlLogo,islastUsedLogo,homePageBackgroundImage,miscueMenuPageBackgroundImage,selectionPagebackgroundURL,sessionPagebackgroundURL,backImageURL,saveImageURL,logoutImageURL,user_Login_id)}if(0<menus.length){var db=Titanium.Database.open('Miscue'),hmrows=db.execute('SELECT * FROM UserMenuItem WHERE userId=?',user_Login_id);1<=hmrows.rowCount&&db.execute('DELETE from UserMenuItem WHERE userId=?',user_Login_id),hmrows.close(),db.close();for(var k=0;k<miscueMenu.length;k++)for(var miscueMenuItemCount=miscueMenu.item(k).getElementsByTagName('MenuItem'),miscueMenuId=menusitm.item(k).getElementsByTagName('Menu').item(0).getAttribute('id'),l=0;l<miscueMenuItemCount.length;l++){var MiscueMenuIcon,miscueMenuItemId=miscueMenu.item(k).getElementsByTagName('MenuItem').item(l).getAttribute('id'),miscueMenuButtonTitle=miscueMenu.item(k).getElementsByTagName('MenuItem').item(l).getAttribute('title');'start'===miscueMenuItemId?MiscueMenuIcon='/images/V1.9/MISCUEMENU_STARTSESSION.png':'resume'===miscueMenuItemId?MiscueMenuIcon='/images/V1.9/resume_last_session.png':'search'===miscueMenuItemId?MiscueMenuIcon='/images/V1.9/review_sessions.png':void 0;var miscueMenuButtonType=miscueMenu.item(k).getElementsByTagName('MenuItem').item(l).getAttribute('type'),miscueMenuButtonposition=miscueMenu.item(k).getElementsByTagName('MenuItem').item(l).getAttribute('position');if('webview'==miscueMenuButtonType)var miscueMenuButtonlink=miscueMenu.item(k).getElementsByTagName('MenuItem').item(l).getAttribute('link');else if('standard'==miscueMenuButtonType)var miscueMenuButtonlink='nulls';r_Miscuedb.insertUserMenuItem(miscueMenuButtonTitle,MiscueMenuIcon,miscueMenuButtonlink,miscueMenuButtonType,miscueMenuButtonposition,user_Login_id,miscueMenuId,miscueMenuItemId)}for(var menuId=menusitm.item(0).getElementsByTagName('menu').item(0).getAttribute('id'),j=0;j<menus.length;j++)for(var menu_Key=menusitm.item(j).getElementsByTagName('menu').item(0).getAttribute('id'),menuitemscount=menus.item(j).getElementsByTagName('menuitem'),i=0;i<menuitemscount.length;i++){var Buttonicon,Buttontitle=menus.item(j).getElementsByTagName('menuitem').item(i).getAttribute('title'),Buttontype=menus.item(j).getElementsByTagName('menuitem').item(i).getAttribute('type'),Buttonposition=menus.item(j).getElementsByTagName('menuitem').item(i).getAttribute('position'),menuItemKey=menus.item(j).getElementsByTagName('menuitem').item(i).getAttribute('id');if('miscueanalysis'===menuItemKey?Buttonicon='/images/V1.9/assess.png':'miscuehelpv2'===menuItemKey?Buttonicon='/images/V1.9/MAINMENU_HELP.png':'aboutus1'===menuItemKey?Buttonicon='/images/V1.9/about_us_button.png':void 0,'webview'==Buttontype)var Buttonlink=menus.item(j).getElementsByTagName('menuitem').item(i).getAttribute('link');else if('standard'==Buttontype)var Buttonlink='nulls';r_Miscuedb.insertUserMenuItem(Buttontitle,Buttonicon,Buttonlink,Buttontype,Buttonposition,user_Login_id,menu_Key,menuItemKey)}}if(0<miscueTypes.length){var db=Titanium.Database.open('Miscue'),miscueTypeDeleteRowCount=db.execute('SELECT * FROM miscueType WHERE userId =? ',user_Login_id);0<miscueTypeDeleteRowCount.rowCount&&db.execute('UPDATE miscueType SET isDeleted = ? WHERE userId =? ','yes',user_Login_id),miscueTypeDeleteRowCount.close(),db.close();for(var miscueType=miscueTypes.item(0).getElementsByTagName('MiscueType'),k=0;k<miscueType.length;k++){var miscueId=miscueTypes.item(0).getElementsByTagName('MiscueType').item(k).getAttribute('id'),miscueText=miscueTypes.item(0).getElementsByTagName('MiscueType').item(k).getAttribute('text'),position=miscueTypes.item(0).getElementsByTagName('MiscueType').item(k).getAttribute('position'),requireNotes=miscueTypes.item(0).getElementsByTagName('MiscueType').item(k).getAttribute('requirenotes'),apiRef=miscueTypes.item(0).getElementsByTagName('MiscueType').item(k).getAttribute('apiref'),colour=miscueTypes.item(0).getElementsByTagName('MiscueType').item(k).getAttribute('colour'),db=Titanium.Database.open('Miscue');miscueTypeDeleteRowCount=null;var miscueTypeRowCount=db.execute('SELECT * FROM miscueType WHERE id=? AND userId=?',miscueId,user_Login_id);if(0<miscueTypeRowCount.rowCount)db.execute('UPDATE miscueType SET isDeleted = ? WHERE id = ? AND userId =? ','no',miscueId,user_Login_id),db.close();else{miscueTypeRowCount.close(),miscueTypeRowCount=null,db.close();var deleted='no';r_Miscuedb.insertUserMiscueType(miscueId,miscueText,position,requireNotes,apiRef,colour,deleted,user_Login_id)}}}var base_URL='https://www.miscue.co.uk/iglooapi/apirequest.aspx',flg=3,text2=0,classStr='<request><requesttype>GETLANGUAGE</requesttype><accesstoken>'+acstkn+'</accesstoken></request>';r_Apifile.createApi(base_URL,classStr,txt1,text2,flg);var db=Titanium.Database.open('Miscue'),homescreencheckrow=db.execute('SELECT * FROM UserMenuItem WHERE userId=?',user_Login_id);if(0<homescreencheckrow.rowCount){db.close();var homewinds=r_miscue.tt.ui.createHomeScreen(txt1,acstkn,flg,backimage);homewinds.open(),loginWin.close()}else db.close(),r_loadingScreen.hideActivity(),alert('There are no menu items for this user')}else if('01'==message){var db=Titanium.Database.open('Miscue');db.execute('UPDATE Login SET checkvalue=? WHERE username=?',0,txt1),db.close();var errormsg=docData.getElementsByTagName('error'),errormessage=errormsg.item(0).getElementsByTagName('message').item(0).textContent;r_loadingScreen.hideActivity(),loginWin.touchEnabled=!0;var labelArray=[];labelArray.title=['Alert','Alert'],labelArray.message=['invalid_Login',errormessage],labelArray[1]=['Ok','OK'];var dialog=r_HomeScreen.createLocalizedAlertDialog(labelArray,txt1);dialog.show()}else{var message='Server is down. Please try again later.'+responses.item(0).getElementsByTagName('result').item(0).textContent,dialog=Ti.UI.createAlertDialog({message:message,ok:'Ok',title:'Server error'});dialog.show(),dialog.addEventListener('click',function(e){0==e.index&&r_loadingScreen.hideActivity()})}return result}exports.callback=callback;var r_HomeScreen=require('/MainMiscue/ui/HomeScreen.js');