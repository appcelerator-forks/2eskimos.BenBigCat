var r_miscue=require('/MainMiscue/miscue.js'),r_notecontent=require('/MainMiscue/ui/notecontent.js'),r_loadingScreen=require('/MainMiscue/ui/loadingScreen'),r_styles=require('/MainMiscue/ui/styles'),r_HomeScreen=require('/MainMiscue/ui/HomeScreen'),r_Miscuedb=require('/MainMiscue/model/Miscuedb');(function(){r_miscue.tt.ui.createSessionWindow=function(usrname,sessionGuid,userId,token,bookGuid,isSessionBookPage,menuItemKey,button_Id){function createMiscueAccuracyLabel(){var miscueaccuracylabels=Ti.UI.createLabel(r_miscue.tt.combine(r_styles.$$.boldHeaderText,{left:'10dp',top:'80dp',color:fontcolour,text:'',font:{fontFamily:pagefontfamily,fontSize:'17dp',fontWeight:'bold'}}));return miscueaccuracylabels}function createButton(pType){var MyId,MyImageField,MyRight;'back'===pType?(MyId='backButton',MyImageField='backImageURL',MyRight='85.5%'):'save'===pType?(MyId='saveButton',MyImageField='saveImageURL',MyRight='1.5%'):void 0;var backbuttonview=Ti.UI.createView({backgroundColor:'transparent',top:'2%',id:'backButton',right:MyRight,touchEnabled:!0});6.8<=Inch?(backbuttonview.height='80dp',backbuttonview.width='90dp'):(backbuttonview.height='45dp',backbuttonview.width='55dp');var db=Titanium.Database.open('Miscue'),userSettingRow=db.execute('SELECT * FROM UserSetting where loginId =?',userId),backbutton=Ti.UI.createImageView({defaultImage:'/images/MISCUE_SAVE.png',backgroundColor:'NONE',height:Titanium.UI.SIZE,id:MyId,width:Titanium.UI.SIZE,color:fontcolour,image:userSettingRow.fieldByName(MyImageField),touchEnabled:!0});return userSettingRow.close(),userSettingRow=null,db.close(),db=null,backbuttonview.add(backbutton),backbuttonview}function createSliderView(){var sliderValuesArray=[];sliderValuesArray=sliderValues.split(','),Ti.API.info('lenght of slider value array '+sliderValuesArray.length),initialTextForAccuracyLabel=null==latestDbSliderValue?sliderValuesArray[0]:latestDbSliderValue;var minValue=0;if(slider=Ti.UI.createSlider({id:'accuracySlider',bottom:Ti.Platform.displayCaps.platformWidth<Ti.Platform.displayCaps.platformHeight?'10%':'15%',right:'10%',left:'10%',touchEnabled:!0,zIndex:101,min:minValue,max:10*(sliderValuesArray.length-1),value:0}),initialTextForAccuracyLabel==sliderValuesArray[sliderValuesArray.length-sliderValuesArray.length])slider.value=minValue;else if(initialTextForAccuracyLabel==sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-1)])slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-1));else if(initialTextForAccuracyLabel==sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-2)])slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-2));else if(initialTextForAccuracyLabel==sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-3)]){slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-3));;}else if(initialTextForAccuracyLabel==sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-4)]){slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-4));;}else if(initialTextForAccuracyLabel==sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-5)]){slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-5));;}else if(initialTextForAccuracyLabel==sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-6)]){slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-6));;}else if(initialTextForAccuracyLabel==sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-7)]){slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-7));;}else if(initialTextForAccuracyLabel==sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-8)]){slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-8));;}else if(initialTextForAccuracyLabel==sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-9)]){slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-9));;}else if(initialTextForAccuracyLabel==sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-10)]){slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-10));;}else if(initialTextForAccuracyLabel==sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-11)]){slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-11));;}else if(initialTextForAccuracyLabel==sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-12)]){slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-12));;}else if(initialTextForAccuracyLabel==sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-13)]){slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-13));;}else if(initialTextForAccuracyLabel==sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-14)]){slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-14));;}else if(initialTextForAccuracyLabel==sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-15)]){slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-15));;}var db=Titanium.Database.open('Miscue'),sessionCheckRow=db.execute('SELECT * FROM MiscueSession WHERE userId = ? AND sessionGuid=? AND ( lastSavedToServerDate != ?)',userId,sessionGuid,'null');return db.close(),(0<sessionCheckRow.rowCount||0<slider.value)&&(backButton.visible=!1),slider.addEventListener('stop',function(e){if(e.value==minValue||e.value<minValue+5)accuracyLabel.text=sliderValuesArray[sliderValuesArray.length-sliderValuesArray.length],slider.value=10*(sliderValuesArray.length-sliderValuesArray.length);else if(e.value>minValue+5&&e.value<minValue+15)accuracyLabel.text=sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-1)],slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-1));else if(e.value>minValue+15&&e.value<minValue+25)accuracyLabel.text=sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-2)],slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-2));else if(e.value>minValue+25&&e.value<minValue+35){accuracyLabel.text=sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-3)],slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-3));;}else if(e.value>minValue+35&&e.value<minValue+45){accuracyLabel.text=sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-4)],slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-4));;}else if(e.value>minValue+45&&e.value<minValue+55){accuracyLabel.text=sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-5)],slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-5));;}else if(e.value>minValue+55&&e.value<minValue+65){accuracyLabel.text=sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-6)],slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-6));;}else if(e.value>minValue+65&&e.value<minValue+75){accuracyLabel.text=sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-7)],slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-7));;}else if(e.value>minValue+75&&e.value<minValue+85){accuracyLabel.text=sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-8)],slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-8));;}else if(e.value>minValue+85&&e.value<minValue+95){accuracyLabel.text=sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-9)],slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-9));;}else if(e.value>minValue+95&&e.value<minValue+105){accuracyLabel.text=sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-10)],slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-10));;}else if(e.value>minValue+105&&e.value<minValue+115){accuracyLabel.text=sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-11)],slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-11));;}else if(e.value>minValue+115&&e.value<minValue+125){accuracyLabel.text=sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-12)],slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-12));;}else if(e.value>minValue+125&&e.value<minValue+135){accuracyLabel.text=sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-13)],slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-13));;}else if(e.value>minValue+135&&e.value<minValue+145){accuracyLabel.text=sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-14)],slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-14));;}else if(e.value>minValue+145){accuracyLabel.text=sliderValuesArray[sliderValuesArray.length-(sliderValuesArray.length-15)],slider.value=10*(sliderValuesArray.length-(sliderValuesArray.length-15));;}var db=Titanium.Database.open('Miscue'),sessionCheckRow=db.execute('SELECT * FROM MiscueSession WHERE userId = ? AND sessionGuid=? AND ( lastSavedToServerDate != ?)',userId,sessionGuid,'null');db.close(),backButton.visible=0<sessionCheckRow.rowCount||0<slider.value?!1:!0}),slider}function createSliderLabel(){return accuracyLabel=Ti.UI.createLabel({id:'sliderLabel',text:initialTextForAccuracyLabel,bottom:Ti.Platform.displayCaps.platformWidth<Ti.Platform.displayCaps.platformHeight?'5%':'10%',width:Titanium.UI.SIZE,height:Titanium.UI.SIZE,color:'purple'}),accuracyLabel}function createUpImageView(){return upImageView=Ti.UI.createImageView({id:'upImageView',bottom:Ti.Platform.displayCaps.platformWidth<Ti.Platform.displayCaps.platformHeight?'10%':'15%',left:'4%',width:'24dp',height:'24dp',image:'/images/sliderDown.png'}),upImageView}function createDownImageView(){return downImageView=Ti.UI.createImageView({id:'downImageView',bottom:Ti.Platform.displayCaps.platformWidth<Ti.Platform.displayCaps.platformHeight?'10%':'15%',right:'4%',width:'24dp',height:'24dp',image:'/images/sliderUp.png'}),downImageView}function hex2rgb(hex,opacity){var h=hex.replace('#','');h=h.match(new RegExp('(.{'+h.length/3+'})','g'));for(var i=0;i<h.length;i++)h[i]=parseInt(1==h[i].length?h[i]+h[i]:h[i],16);return'undefined'!=typeof opacity&&h.push(opacity),'rgba('+h.join(',')+')'}function createLastModifiedDate(){var lastmodifiedDate=new Date;return lastmodifiedDate=lastmodifiedDate.toISOString(),lastmodifiedDate}function createhtml(bookContent,bookTitle){var html='<!DOCTYPE html><html ID = "htmlTap"><head>';return html+='<meta http-equiv="Content-Type" content="text/html";charset="utf-8" >',html+='<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"/>',html+='<style type="text/css">.Highlites {background-color:#808080;} .DeHighlites {background-color: ;}.extraHtmlBox {word-break:break-all;word-spacing: -5px;letter-spacing: -5px;width:98%; padding:2%; line-height:normal;}  .box{word-break:break-all;word-spacing: -5px;letter-spacing: -5px;width:98%; padding:2%; line-height:normal;} body{font-family: Arial;-webkit-user-select:none; -webkit-touch-callout: none; font-size:1.5em;width:96%;background-color:backcolour;} html{  -webkit-user-select: none;-webkit-touch-callout: none;-webkit-text-size-adjust : none; text-size-adjust: none;}',html+='</style>',html+='<script src="MainMiscue/ui/JqueryPlugin.js.bug"></script>',html+='<script>function fontsize(size){',html+='$("body").css("font-size", size);',html+='}',html+=' function addBackgroundcolor(singletapvals,col){',html+='function hex2rgb(hex, opacity) { var h=hex.replace(\'#\', \'\');',html+='h =  h.match(new RegExp(\'(.{\'+h.length/3+\'})\', \'g\')); for(var i=0; i<h.length; i++)',html+='h[i] = parseInt(h[i].length==1? h[i]+h[i]:h[i], 16); if (typeof opacity != \'undefined\')  h.push(opacity);',html+='return \'rgba(\'+h.join(\',\')+\')\';}',html+='var colour = hex2rgb(col,0.3);',html+='$( \'span\' ).eq( singletapvals ).css(\'background\',colour);',html+='$( \'span\' ).eq( singletapvals ).css(\'color\',col);',html+='$(\'span\').eq(singletapvals).css(\'border-radius\',\'15px\');',html+='}',html+=' function singleTapBackgroundColor(singletapval,backcolour,fontcolour){',html+='$( \'span\' ).eq( singletapval ).css(\'background\',fontcolour);',html+='$( \'span\' ).eq( singletapval ).css(\'color\',backcolour);',html+='$(\'span\').eq(singletapval).css(\'border-radius\',\'1px\');',html+='}',html+=' function winrefresh(singletapval,backcolour,fontcolour){',html+='$( \'span\' ).eq( singletapval ).css(\'background\',\'transparent\');',html+='$( \'span\' ).eq( singletapval ).css(\'color\', fontcolour);',html+='$( \'span\' ).eq( singletapval ).removeClass( \'Highlites\' );',html+='$( \'span\' ).eq( singletapval ).addClass( \'DeHighlites\' );',html+='}',html+='(function($) {',html+=' $(document).ready(function() {',html+='i=0;',html+='windowHeight = $(window).height();',html+='var heightWindow = windowHeight;',html+='$(\'html\').css(\'height\', \'90%\');',html+='$(\'body\').css(\'min-height\', \'100%\');',html+='document.getElementById("txt").style.left="1px";',html+='$(\'span\').click(function(event) {',html+='var classs = event.target.id+" and "+$(event.target).attr(',html+='\'class\');',html+='var spanId = event.target.id;',html+='var spanBackgroundColor = document.getElementById(spanId).style.backgroundColor;',html+='var Color = document.getElementById(spanId).style.color;',html+='if(spanBackgroundColor != \'transparent\'){',html+='if(Color != \'\'){',html+='var offsets = document.getElementById(spanId).getBoundingClientRect();',html+='Ti.App.fireEvent',html+='(\'app:single\', {spanIndex:spanId,spanbackColor: spanBackgroundColor,scrollEnd:\'true\'});}}',html+='else if(spanBackgroundColor == "transparent") {',html+='var indexOfWord = event.target.id;var selectedWord = document.getElementById(indexOfWord).innerText;',html+='var spanBackgroundColor = document.getElementById(indexOfWord).style.backgroundColor;',html+='if(Color != \'\'){',html+='var spanId = event.target.id;',html+='var offsets = document.getElementById(spanId).getBoundingClientRect();',html+='var miscueMenuLeftPosValue = offsets.left;',html+='Ti.App.fireEvent',html+='(\'app:long\', {data: selectedWord,spanIndex:indexOfWord,miscueMenuLeftValue:miscueMenuLeftPosValue,spanbackColor: spanBackgroundColor,scrollEnd:\'true\'});',html+='}}',html+='});',html+='});})(window.jQuery);',html+='</script></head>',html+='<body ID="newtext2" style="padding-bottom:12%;  -webkit-user-select: none; -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent; -moz-user-select: none; -ms-user-select: none; user-select: none;">',html+='<h2  id=\'heading\'',html+='style="word-break:break-all;font-size:2em;word-spacing: -6px;letter-spacing: -6px;">',html+=bookTitle,html+='</h2>',html+='<div id="txt" class="box">',html+=bookContent,html+='</div > <br /><br />',html+='<span style="font-size:1em;word-spacing: 5px;letter-spacing: normal; line-height: 50px;display:inline-block;padding:10px 15px 10px 15px;">',html+=extraHTML,html+='</span>',html+='</body></html>',html}function convertFromPxToDp(){'android'==osname?(bottommenuMainViewWidth=Ti.Platform.displayCaps.platformWidth,bottommenuMainViewWidth/=Titanium.Platform.displayCaps.dpi/160,bottommenuMainView.width=bottommenuMainViewWidth):(bottommenuMainViewWidth=Ti.Platform.displayCaps.platformWidth,bottommenuMainView.width=bottommenuMainViewWidth,'iphone'==osname&&(bottommenuMainView.width=Ti.Platform.displayCaps.platformWidth))}function bottomViewConfigOnOrientationMode(){var screenRes=r_loadingScreen.backgroundImageHeightWidthPxToDp();screenBackgroundImage[1].height=6.8>Inch?screenRes[1]+130:'android'==osname?screenRes[1]+200:screenRes[1]+110,screenBackgroundImage[1].width=screenRes[0],Ti.Platform.displayCaps.platformWidth<Ti.Platform.displayCaps.platformHeight?(6.8<=Inch&&(learnerNameLabels.top='14dp',groupNamelabels.top='42dp',accuracy_Label.top='80dp'),recordView.left='iphone'==osname?'35.5%':'39.5%','true'==Ti.App.Properties.getString('isAudioPlayingProcess')&&(playView.left='37.5%')):('android'==osname&&Ti.Platform.displayCaps.platformWidth>Ti.Platform.displayCaps.platformHeight&&(learnerNameLabels.top='8dp',groupNamelabels.top='30dp',accuracy_Label.top='60dp'),recordView.left='42%','true'==Ti.App.Properties.getString('isAudioPlayingProcess')&&(playView.left='41%'))}function flashRecord(){recordView.visible=!0!=recordView.visible}function recalculateAccuracy(){var db=Titanium.Database.open('Miscue'),miscueItemrow=db.execute('SELECT * FROM MiscueSessionItem  where miscueSessionId =?',sessionGuid),miscueItemrowCount=miscueItemrow.rowCount;return miscueItemrow.close(),miscueItemrow=null,db.close(),db=null,miscueAccuracy=100*(bookcontentcount.length-miscueItemrowCount)/bookcontentcount.length,miscueAccuracy=parseFloat(miscueAccuracy).toFixed(2),Ti.API.info('book content '+bookcontentcount),Ti.API.log('bookcontentcount.length is :: ',bookcontentcount.length),Ti.API.log('miscueItemrowCount is :: ',miscueItemrowCount),Ti.API.log('bookcontentcount.length is :: ',bookcontentcount.length),miscueAccuracy}function saveMiscueSessionOnBackButton(){function checkDevicePermissions(){if(Ti.API.info('----------BEN!!! Checking device permissions'),Ti.Filesystem.hasStoragePermissions()?Ti.API.info('----------BEN!!! Has storage permissions...'):Ti.API.info('----------BEN!!! NOT have storage permissions...'),Ti.Media.hasCameraPermissions())return Ti.API.info('----------BEN!!! I already have access to storage!'),!0;Ti.API.info('----------BEN!!! I cannot access the storage, attempting to get access...');try{Ti.API.info('----------BEN!!! Try started...'),Ti.Media.requestCameraPermissions(function(e){return Ti.API.info('----------BEN!!! Permission requested...'),e.success?(Ti.API.info('----------BEN!!! I managed to get permission to storage.'),!0):(Ti.API.info('----------BEN!!! I cannot access the storage, please check device Settings.'),!1);Ti.API.info('----------BEN!!! End of permission request...')}),Ti.API.info('----------BEN!!! End of try...')}catch(e){Ti.API.info('----------BEN!!! There was an error whilst trying to get access to the storage! Error: '+e)}}function moveAudioToPermanentStorage(){if(Ti.API.info('---------- BEN - Attempting to move audio file to permanent storage...'),'null'!==file&&null!==file){var temp=file.nativePath.split('/'),audioFileName=temp[temp.length-1];Ti.API.info('---------- BEN - The audio file itself is called = '+audioFileName);var cachedAudioFile=Ti.Filesystem.getFile(Ti.Filesystem.applicationCacheDirectory,audioFileName);if(!Ti.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory,audioFileName).exists()){var newFileDirectory=Ti.Filesystem.applicationDataDirectory+'/'+audioFileName;Ti.API.info('---------- BEN - Attempting to move audio file from the cache to the application data directory. The new directory will be: '+newFileDirectory),cachedAudioFile.move(newFileDirectory),Ti.API.info('---------- BEN - file was successfully moved from the cache to the application data directory!')}else Ti.API.info('---------- BEN - The audio file has already been moved from the cache to permanent storage. Move will be skipped.')}else Ti.API.info('---------- BEN - There was no audio file to move. Move will be skipped.')}if(Ti.API.info('----------BEN!!! The miscue session is being saved...'),checkDevicePermissions(),moveAudioToPermanentStorage(),!0==singletapwin.visible)Ti.API.info('----------BEN!!! singletapwin is visible!'),miscueMenuCloseView.visible=!1,miscueMenuCloseView.touchEnabled=!1,singletapwin.hide(),singletapwin.visible=!1,sessionwebview.touchEnabled=!0;else{if(Ti.API.info('----------BEN!!! singletapwin is NOT visible!'),initialTextForAccuracyLabel!==accuracyLabel.text){var db=Titanium.Database.open('Miscue');db.execute('UPDATE MiscueSession SET isSessionModified = ? WHERE userId=? AND sessionGuid = ?','true',userId,sessionGuid),db.close(),db=null}var db=Titanium.Database.open('Miscue'),checkEditSessionRow=db.execute('SELECT * FROM MiscueSession WHERE sessionGuid = ? AND userId = ? AND (isSessionModified = \'true\' OR lastModifiedDate > lastSavedToServerDate OR lastSavedToServerDate = \'null\') ',sessionGuid,userId),checkEditSessionRowCount=checkEditSessionRow.rowCount;checkEditSessionRow.close(),checkEditSessionRow=null,db.close(),db=null,Ti.API.info('saving session');var labelArray=[];labelArray.message=['saving_Indicator','Please wait...'],r_loadingScreen.showActivity(labelArray.message,usrname),file='null'!=file&&null!=file?file.getName():'null';var localSliderValueString=accuracyLabel.text;Ti.API.info('localSliderValueString : '+localSliderValueString),Ti.API.info('insert/update single value at save'+localSliderValueString+'with bookGUID='+bookGuid+' and user id '+userId+' learner guid '+learnerguid),Ti.API.info('---------- BEN - First, I am updating the \'sliderValue\' (understanding) for this session on the local database.');var db=Titanium.Database.open('Miscue');if(db.execute('UPDATE MiscueSession SET sliderValue = ? WHERE bookGUID = ? AND userId = ? AND learnerGuid = ?',localSliderValueString,bookGuid,userId,learnerguid),db.close(),Ti.API.info('---------- BEN - Secondly, I am calling HomeScreen.createSubmitMiscueSession which finishes off creating me on the local database. A file is sent to this function. The type is = '+file+' and the directory is = '+file.nativePath),r_HomeScreen.createSubmitMiscueSession(userId,sessionGuid,token,sessionWin,isSessionBookPage,token,file,accuracyLabel.text),Ti.API.info('---------- BEN - Successfully completed HomeScreen.createSubmitMiscueSession.'),r_loadingScreen.hideActivity(),'book'==isSessionBookPage){var miscuewindow=r_miscue.tt.ui.createmiscueMenuPage(usrname,token,menuItemKey,userId);miscuewindow.open(),sessionWin.close()}else if('search'==isSessionBookPage){var searchSession=r_miscue.tt.ui.createsearchSession(usrname,userId,token,menuItemKey);searchSession.open(),sessionWin.close()}file=null,Ti.App.removeEventListener('app:single',singleTap),Ti.App.removeEventListener('app:long',longTap)}Ti.App.Properties.setString('isAudioPlayingProcess','false'),Ti.UI.createAlertDialog({title:'Saved successfully',message:Ti.App.Properties.getString('readingResultsMessage')}).show()}function getOrientation(orientVal){var value;return value=1===orientVal?1:4===orientVal?2:2===orientVal?3:3===orientVal?4:0,value}function orientionChangeMode(e){return;Ti.API.info('change orentaion call');var orientVal=e.source.orientation,orientationVal=getOrientation(orientVal);orientationVal!=orientCount&&0!=orientationVal&&(orientCount=orientationVal,bottomViewConfigOnOrientationMode(),e.orientation===Ti.UI.LANDSCAPE_RIGHT||e.orientation===Ti.UI.LANDSCAPE_LEFT?(sessionwebview.height='50%',slider.bottom='15%',upImageView.bottom='15%',downImageView.bottom='15%',accuracyLabel.bottom='10%',convertFromPxToDp(),1==menuBarView.visible&&(bottommenuMainView.animate({bottom:bottomMenuBottomDownValue,duration:animSpeed}),toolbarShowButton.backgroundImage='/images/phase5/SHOWMENU.png',menuBarView.visible=!1)):(sessionwebview.height='70%',slider.bottom='10%',upImageView.bottom='10%',downImageView.bottom='10%',accuracyLabel.bottom='5%',convertFromPxToDp(),1==menuBarView.visible&&(bottommenuMainView.animate({bottom:bottomMenuBottomDownValue,duration:animSpeed}),toolbarShowButton.backgroundImage='/images/phase5/SHOWMENU.png',menuBarView.visible=!1)));var screenRes=r_loadingScreen.backgroundImageHeightWidthPxToDp();screenBackgroundImage[1].width=screenRes[0],Ti.Platform.displayCaps.platformWidth>Ti.Platform.displayCaps.platformHeight?(screenBackgroundImage[1].height=screenRes[1],Ti.API.info('or change landscape'+screenBackgroundImage[1].height)):('ipad'==osname||'iphone'==osname?(screenBackgroundImage[1].height=Titanium.Platform.displayCaps.platformHeight-Titanium.Platform.displayCaps.platformHeight/2.5,Ti.API.info('or change portrair ipad and iPhone'+screenBackgroundImage[1].height)):(screenBackgroundImage[1].height=Titanium.Platform.displayCaps.platformHeight/(Titanium.Platform.displayCaps.dpi/120),Ti.API.info('or change portrair android'+screenBackgroundImage[1].height)),Inch>=InchValue&&('iphone'==osname||'ipad'==osname?(screenBackgroundImage[1].height=Titanium.Platform.displayCaps.platformHeight,Ti.API.info('or change inch > value portrair iphone or ipad'+screenBackgroundImage[1].height)):(screenBackgroundImage[1].height=Titanium.Platform.displayCaps.platformHeight/(Titanium.Platform.displayCaps.dpi/100),Ti.API.info('or change inch > value portrair android'+screenBackgroundImage[1].height))))}function saveAdditionalInfo(){miscueMenuCloseView.visible=!1,miscueMenuCloseView.touchEnabled=!1;var textNote=txtfield.value;if(textNote=textNote.replace(/'/gi,'&apos;'),''==textNote){var labelArray=[];labelArray.message=['Empty_Input_Window_Message','Field is Empty'],r_HomeScreen.createLocalizedShowToastMessage(labelArray.message,usrname)}else{var db=Titanium.Database.open('Miscue'),miscueTypeRow=db.execute('SELECT apiRef FROM miscueType WHERE userId = ? AND id = ?',userId,miscueMenuLabelId),apiRef=miscueTypeRow.fieldByName('apiRef');miscueTypeRow.close(),miscueTypeRow=null,db.close(),db=null,r_Miscuedb.insertMiscueSessionItem(sessionGuid,textNote,miscueMenuLabelId,countval,startchar,endchar,additionalInfo,apiRef);var colorVal=selectedMiscueTypeColor;sessionwebview.evalJS('addBackgroundcolor(\''+countval+'\',\''+colorVal+'\')'),miscueAccuracy=recalculateAccuracy();var db=Titanium.Database.open('Miscue');db.execute('UPDATE MiscueSession SET accuracyValue =?, lastModifiedDate=?,isSessionModified = ?,isLastEditedSession = ? WHERE userId=? AND sessionGuid = ?',miscueAccuracy,createLastModifiedDate(),'true','true',userId,sessionGuid),db.close(),db=null,subwin.close(),subwinView.visible=!1,txtfield.value='',miscue_menu=null,countval=null,additionalInfo=null,miscueMenuLabelId=null,startchar=null,endchar=null,valencr=null,sessionwebview.touchEnabled=!0,zoomin.touchEnabled=!0,zoomout.touchEnabled=!0,saveButton.touchEnabled=!0,notesbuttonview.touchEnabled=!0}}var osname=Ti.Platform.osname,wid=Titanium.Platform.displayCaps.platformWidth,hght=Titanium.Platform.displayCaps.platformHeight,db=Titanium.Database.open('Miscue'),homerow=db.execute('SELECT * FROM UserSetting where loginId =?',userId),schoolnames=homerow.fieldByName('schoolName'),backpage=homerow.fieldByName('backPage'),backcolour=homerow.fieldByName('backgroundColor'),fontcolour=homerow.fieldByName('fontColor'),pagefontfamily=homerow.fieldByName('charFont');Ti.API.log('Font is  :: ',pagefontfamily);var accuracyLabel,slider,upImageView,downImageView,initialTextForAccuracyLabel,pagelogo=homerow.fieldByName('logos'),sessionBackgroundImage=homerow.fieldByName('sessionPagebackgroundURL'),dec=Ti.Utils.base64decode(schoolnames),animSpeed=500;homerow.close(),db.close();var iOS7=r_loadingScreen.isiOS7Plus(),sessionWin=Ti.UI.createWindow({navBarHidden:!0,backgroundColor:'white',title:'Miscue',fullscreen:!0});7<=iOS7&&(sessionWin.top='20dp');var screenBackgroundImage=r_loadingScreen.mainBackgroundImage(sessionBackgroundImage);sessionWin.add(screenBackgroundImage[0]);var screenRes=r_loadingScreen.backgroundImageHeightWidthPxToDp(),Inch=r_loadingScreen.screenInch();screenBackgroundImage[1].height=6.8>Inch?screenRes[1]:'android'==osname?screenRes[1]+200:screenRes[1]+110,screenBackgroundImage[1].width=screenRes[0],6.8>Inch&&'android'==osname?sessionWin.orientationModes=[Titanium.UI.PORTRAIT]:'iphone'!=osname&&6.8<=Inch?sessionWin.orientationModes=[Titanium.UI.PORTRAIT]:'android'==osname&&(sessionWin.orientationModes=[Titanium.UI.PORTRAIT]);var learnerNameLabels=Ti.UI.createLabel(r_miscue.tt.combine(r_styles.$$.boldHeaderText,{top:6.8<=Inch?'14dp':'5dp',left:'24.5%',color:fontcolour,width:'39%',ellipsize:!0,wordWrap:!1,backgroundColor:'transparent'})),deleteLocalizedText='Delete',db=Titanium.Database.open('Miscue');db.execute('BEGIN');var localizedTextRow=db.execute('SELECT * FROM Language WHERE labelId = ? AND userId = ?','Delete',usrname);0<localizedTextRow.rowCount&&(deleteLocalizedText=localizedTextRow.fieldByName('label')),localizedTextRow.close();var miscueSessionRow=db.execute('SELECT * FROM UserBook T1,MiscueSession T2 WHERE T2.sessionGuid = ? AND T2.userId = ? AND T1.bookGuid = ?',sessionGuid,userId,bookGuid),audioName=miscueSessionRow.fieldByName('recordedAudioFilename'),bookname=miscueSessionRow.fieldByName('bookName');bookname=bookname.replace(/&quot;/gi,'\'');var encryptedBookContent=miscueSessionRow.fieldByName('bookContents'),extraHTML=miscueSessionRow.fieldByName('extraHTML');extraHTML=Ti.Utils.base64decode(extraHTML);var bookcontent=Ti.Utils.base64decode(encryptedBookContent),learnerguid=miscueSessionRow.fieldByName('learnerGuid'),miscueAccuracy=miscueSessionRow.fieldByName('accuracyValue'),sliderValues=miscueSessionRow.fieldByName('sliderValues'),testSessionRow=db.execute('SELECT * FROM MiscueSession WHERE bookGUID = ? AND userId = ? AND learnerGuid = ?',bookGuid,userId,learnerguid),latestDbSliderValue=testSessionRow.fieldByName('sliderValue');Ti.API.info('slider value got from DB at entry: '+latestDbSliderValue+' book guid '+bookGuid+': user id '+userId+' learner guid '+learnerguid);var groupLearenrrow=db.execute('SELECT * FROM LearnerGroup G, Learner L WHERE L.groupGuid=G.groupGuid AND L.learnerGuid = ?',learnerguid),learnername=groupLearenrrow.fieldByName('learnerName'),groupname=groupLearenrrow.fieldByName('groupName');miscueSessionRow.close(),groupLearenrrow.close();var isDeletedGroupLearnerBook='no',bookData=db.execute('SELECT U.bookGuid as ID,U.deleted as Deleted FROM UserBook U WHERE U.userId = ? AND U.bookGuid = ? and U.deleted = \'yes\'',userId,bookGuid);if(0<bookData.rowCount)isDeletedGroupLearnerBook='yes';else{var learnerData=db.execute('SELECT L.groupGuid as groupGuid,L.learnerGuid as ID,L.deleted as Deleted FROM Learner L WHERE L.learnerGuid = ? AND L.userId = ?',learnerguid,userId);if(0==learnerData.rowCount||'yes'==learnerData.fieldByName('deleted'))isDeletedGroupLearnerBook='yes';else{var groupData=db.execute('SELECT G.groupGuid as ID,G.deleted as Deleted FROM LearnerGroup G WHERE G.loginUserId = ? AND G.groupGuid = ? AND G.deleted = \'yes\'',userId,learnerData.fieldByName('groupGuid'));0<groupData.rowCount&&(isDeletedGroupLearnerBook='yes'),groupData.close()}learnerData.close()}if('yes'==isDeletedGroupLearnerBook){var labelArray=[];labelArray.title=['Alert','Alert'],labelArray.message=['group_Learner_Book_Delete_Message','Session cannot be modified as one or more of  group/learner/book is deleted'],labelArray[1]=['Ok','Ok'];var dialog=r_HomeScreen.createLocalizedAlertDialog(labelArray,usrname);dialog.show()}bookData.close(),db.execute('COMMIT'),db.close();var bookcontentcount=bookname+' '+bookcontent;bookcontentcount=bookcontentcount.replace(/\n/g,' '),bookcontentcount=bookcontentcount.replace(/\s\s+/g,' '),bookcontentcount=bookcontentcount.trim(),bookcontentcount=bookcontentcount.split(' ');var groupnamelabel=groupname.replace('&quot;','\''),groupNamelabels=Ti.UI.createLabel(r_miscue.tt.combine(r_styles.$$.boldHeaderText,{text:groupnamelabel,left:'24.5%',top:'40dp',color:fontcolour,width:'39%',height:'40dp',ellipsize:!0,wordWrap:!1,font:{fontFamily:pagefontfamily,fontSize:'17dp',fontWeight:'bold'}})),accuracy_Label=createMiscueAccuracyLabel(),saveButton=createButton('save');sessionWin.add(saveButton);var backButton=createButton('back');sessionWin.add(backButton);var accuracySlider=createSliderView(),accuracyLabel=createSliderLabel(),upImageViewThumb=createUpImageView(),downImageViewThumb=createDownImageView();sessionWin.add(accuracySlider),sessionWin.add(accuracyLabel),sessionWin.add(upImageViewThumb),sessionWin.add(downImageViewThumb),sessionWin.add(groupNamelabels),sessionWin.add(learnerNameLabels),sessionWin.add(accuracy_Label);var learnernamelabel=learnername.replace('&quot;','\'');6.8<=Inch||'ipad'==osname?(learnerNameLabels.font={fontSize:'23dp',fontFamily:pagefontfamily,fontWeight:'bold'},learnerNameLabels.text=learnernamelabel,'android'==osname&&Ti.Platform.displayCaps.platformWidth>Ti.Platform.displayCaps.platformHeight&&(learnerNameLabels.top='10dp',groupNamelabels.top='30dp',accuracy_Label.top='60dp')):(groupNamelabels.top='20dp',accuracy_Label.top='52dp',learnerNameLabels.font={fontSize:'15dp',fontFamily:pagefontfamily,fontWeight:'bold'},groupNamelabels.font={fontSize:'14dp',fontFamily:pagefontfamily,fontWeight:'bold'},accuracy_Label.font={fontSize:'14dp',fontFamily:pagefontfamily,fontWeight:'bold'},learnerNameLabels.text=learnernamelabel);var bookcontent=bookcontent.toString();bookcontent=bookcontent.replace(/\r\n/gi,' '),bookcontent=bookcontent.replace(/( *\<br *\/> *)/gi,' <br /> '),bookcontent=bookcontent.replace(/(^\s*)|(\s*$)/gi,''),bookcontent=bookcontent.replace(/[ ]{2,}/gi,' '),bookcontent=bookcontent.replace(/\n/g,' '),Ti.API.info('book content: '+bookcontent);var val=bookcontent.split(' ').length;Ti.API.info('val: '+val);var titLength=bookname.split(' ').length,valss=bookcontent.split('<br />'),ln=valss[0].length,contentOfBook='',db=Titanium.Database.open('Miscue');book_Name=bookname.split(' ');var index_texts,z,titleOfBook='',titleflag=!1,titlecount=0;for(z=0;z<book_Name.length;z++){for(var s=z,miscueDatarowcount=db.execute('SELECT * FROM MiscueSessionItem WHERE miscueSessionId=? ',sessionGuid),k=0;k<miscueDatarowcount.rowCount;k++){index_texts=miscueDatarowcount.fieldByName('indexofword');var miscueMenuVal=miscueDatarowcount.fieldByName('miscueMenu');if(titlecount==index_texts){var miscueTypeColorCheckRow=db.execute('SELECT * FROM miscueType WHERE userId = ? AND id = ?',userId,miscueMenuVal),colorCode=miscueTypeColorCheckRow.fieldByName('colour'),miscueTypeBackgroundColor=hex2rgb(colorCode,0.3);titleflag=!0;break}miscueDatarowcount.next()}miscueDatarowcount.close(),miscueDatarowcount=null,!0==titleflag?tittleSpan='<span id = '+z+' CLASS="heading" style = "border-radius:15px;word-break:break-all;display:inline-block;background-color:'+miscueTypeBackgroundColor+';color:'+colorCode+';padding:10px 5px 10px 5px;word-spacing: normal;letter-spacing: normal;">'+book_Name[z]+'</span>&nbsp;':!0!=titleflag&&titlecount<=book_Name.length&&(tittleSpan='<span id = '+z+' CLASS="heading" style = "border-radius: 15px;color:'+fontcolour+';word-break:break-all; background-color:transparent;display:inline-block;padding:10px 5px 10px 5px;word-spacing: normal;letter-spacing: normal;">'+book_Name[z]+'</span>&nbsp;'),titleOfBook+=tittleSpan,titlecount++,titleflag=!1}for(var rowcnt,str1,n,miscueDatarow,strspan1,flag,count=0,i=0;i<val;i++){flag=!1,miscueDatarow=db.execute('SELECT * FROM MiscueSessionItem WHERE miscueSessionId=? ',sessionGuid),rowcnt=miscueDatarow.rowCount,str1=bookcontent.replace(/\n/g,' ').split(' '),n=str1[i].length;var strn=str1[i].substr(n-4,n),strnchar=str1[i].substr(0,2);if('<br'==str1[i]&&'/>'==str1[i+1])str1[i]=str1[i]+' '+str1[i+1],str1[i]=str1[i].replace(str1[i],'<br>');else if('<br'==str1[i]&&'/>'!=str1[i+1]){var strlength=str1[i+1].length,first_str=str1[i+1].substr(0,2);str1[i]=str1[i]+' '+first_str,str1[i]=str1[i].replace(str1[i],'<br>');var secondstr=str1[i+1].substr(2,strlength)}var testingindex=str1.indexOf(str1[i]);if(1<=rowcnt){for(var l=0;l<miscueDatarow.rowCount;l++){var index_text=miscueDatarow.fieldByName('indexofword'),miscueMenuValue=miscueDatarow.fieldByName('miscueMenu');if(index_text-=titLength,count==index_text){var miscueTypeColorCheckValueRow=db.execute('SELECT * FROM miscueType WHERE userId = ? AND id = ?',userId,miscueMenuValue),colorCodeValue=miscueTypeColorCheckValueRow.fieldByName('colour'),miscueTypeBackgroundColorValue=hex2rgb(colorCodeValue,0.3);flag=!0,miscueTypeColorCheckValueRow.close();break}miscueDatarow.next()}if(!0==flag)strspan1='<br>'==str1[i]?'<span id= '+(i+z)+'  CLASS="text" style="border:2px;border-radius:15px;display: inline-block;background-color:'+miscueTypeBackgroundColorValue+';padding:10px 5px 10px 5px;color: '+colorCodeValue+';word-spacing: normal;letter-spacing: normal;">'+str1[i]+'</span>&nbsp;':'<span id= '+(i+z)+'  CLASS="text" style="border:2px;border-radius:15px;background-color:'+miscueTypeBackgroundColorValue+';display:inline-block;padding:10px 5px 10px 5px;color:'+colorCodeValue+';word-spacing: normal;letter-spacing: normal;" >'+str1[i]+'</span>&nbsp;';else if('/>'==str1[i]);else if('<br'==str1[i-1]&&'/>'!=str1[i]){var secondstr1=str1[i].substr(2,str1[i].length);str1[i]=secondstr1,strspan1='<span id= '+(i+z)+'  CLASS="text" style = "border:2px;border-radius:15px;background-color:transparent;display:inline-block;padding:10px 5px 10px 5px;color:'+fontcolour+';word-spacing: normal;letter-spacing: normal;">'+str1[i]+'</span>&nbsp;'}else strspan1='<br>'==str1[i]?'<span id= '+(i+z)+'  CLASS="text" style = color:'+fontcolour+';padding:0px 0px 0px 0px;word-spacing: normal;background-color:transparent;letter-spacing: normal;" >'+str1[i]+'</span>&nbsp;':'<span id= '+(i+z)+'  CLASS="text" style = "border:2px;border-radius:15px;display:inline-block;color:'+fontcolour+';padding:10px 5px 10px 5px;background-color:transparent;word-spacing: normal;letter-spacing: normal;" >'+str1[i]+'</span>&nbsp;'}else if('/>'==str1[i]);else if('<br'==str1[i-1]&&'/>'!=str1[i]){var secondstr1=str1[i].substr(2,str1[i].length);str1[i]=secondstr1,strspan1='<span id= '+(i+z)+'  CLASS="text" style = "border:2px;border-radius:15px;word-spacing: normal;letter-spacing: normal;background-color:transparent;display:inline-block;color:'+fontcolour+';padding:10px 5px 10px 5px;">'+str1[i]+'</span>&nbsp;'}else strspan1='<br>'==str1[i]?'<span id= '+(i+z)+'  CLASS="text" style = "border:2px;border-radius:15px;word-spacing: normal;letter-spacing: normal;background-color:transparent;padding:10px 5px 10px 5px;">'+str1[i]+'</span>&nbsp;':'<span id= '+(i+z)+'  CLASS="text" style = "border:2px;border-radius:15px;word-spacing: normal;letter-spacing: normal;background-color:transparent;display:inline-block;color:'+fontcolour+';padding:10px 5px 10px 5px;" >'+str1[i]+'</span>&nbsp;';contentOfBook+=strspan1,count++,miscueDatarow.close(),miscueDatarow=null}db.close();var bottomMenuBottomUpValue,htmlContents=createhtml(contentOfBook,titleOfBook),webviewcontainer=Ti.UI.createView({backgroundColor:'transparent',width:'100%',height:'100%'}),sessionwebview=Ti.UI.createWebView({backgroundColor:'transparent',width:'100%',height:Ti.Platform.displayCaps.platformWidth<Ti.Platform.displayCaps.platformHeight?'70%':'50%',enableZoomControls:!1}),bottomMenuBottomDownValue=-45,bottommenuMainViewWidth=Ti.Platform.displayCaps.platformWidth;6.8<=Inch&&(bottomMenuBottomDownValue=-75);var bottommenuMainView=Ti.UI.createView({height:6.8<=Inch?'110dp':'70dp',bottom:bottomMenuBottomDownValue,backgroundColor:'transparent'});convertFromPxToDp();var toolbarShowButton=Ti.UI.createButton({top:0,height:6.8<=Inch?'35dp':'25dp',width:6.8<=Inch?'150dp':'120dp',backgroundImage:'/images/phase5/SHOWMENU.png',backgroundColor:'transparent'});6.8<=Inch&&'android'==osname?(webviewcontainer.top='120dp',sessionwebview.top='0dp'):'ipad'==osname?(webviewcontainer.top='130dp',sessionwebview.top='0dp'):(webviewcontainer.height='90%',webviewcontainer.top='98dp',sessionwebview.top='1%'),'android'==Ti.Platform.osname&&(sessionwebview.addEventListener('longclick',function(){return!1}),sessionwebview.addEventListener('longpress',function(){return!1})),webviewcontainer.add(sessionwebview),sessionWin.add(webviewcontainer),sessionwebview.html=htmlContents;var actInd=Titanium.UI.createActivityIndicator();webviewcontainer.addEventListener('beforeload',function(){actInd.message='Loading...','android'==osname}),sessionwebview.addEventListener('load',function(){Ti.API.info('call on orientation chaneg')});var singleTapWindowCount=0,menuBarView=Ti.UI.createWindow({backgroundColor:'white',bottom:0,width:'100%',visible:!1}),bottomMenu=Ti.UI.createView({top:6.8<=Inch?'34dp':'25dp',width:'100%',height:6.8<=Inch?76:45,backgroundColor:'white',backgroundImage:'/images/phase5/MENUBACKGROUND.png'}),menubarbutton=Ti.UI.createView({backgroundColor:'#c2d7e1',top:0,height:'5%',width:'100%'}),notesbuttonview=Ti.UI.createView({backgroundColor:'transparent',bottom:'5dp',height:bottomMenu.height-15,width:bottomMenu.height-15,right:'2%'}),notesbutton=Ti.UI.createImageView({backgroundColor:'transparent',height:Titanium.UI.FILL,width:Titanium.UI.FILL,image:'/images/phase5/EDITNOTES.png',touchEnabled:!1}),zoomin=Ti.UI.createImageView({backgroundColor:'transparent',height:bottomMenu.height-15,width:bottomMenu.height-15,left:'0%',image:'/images/phase5/MAGNIFYPLUS.png'}),zoomout=Ti.UI.createImageView({height:bottomMenu.height-15,width:bottomMenu.height-15,left:zoomin.width+5,image:'/images/phase5/MAGNIFYMINUS.png'}),recordView=Ti.UI.createView({backgroundColor:'transparent',bottom:'5dp',height:bottomMenu.height-15,width:bottomMenu.height-15}),recordImage=Ti.UI.createImageView({backgroundColor:'transparent',height:Titanium.UI.FILL,width:Titanium.UI.FILL,image:'/images/phase5/RECORD.png'}),playView=Ti.UI.createView({backgroundColor:'transparent',bottom:'5dp',height:bottomMenu.height-15,width:bottomMenu.height-15,visible:!1,touchEnabled:!1,left:'iphone'==osname?'51%':'49.5%'});'android'==osname&&(playView.left='50.5%');var playImage=Ti.UI.createImageView({backgroundColor:'transparent',height:Titanium.UI.FILL,width:Titanium.UI.FILL,image:'/images/blurPlay.png'}),stopPlaybackView=Ti.UI.createView({backgroundColor:'transparent',bottom:'5dp',height:bottomMenu.height-15,width:bottomMenu.height-15,left:'iphone'==osname?'50%':'49.5%',visible:!1}),stopPlaybackImage=Ti.UI.createImageView({backgroundColor:'transparent',height:Titanium.UI.SIZE,width:Titanium.UI.SIZE,right:'0%',image:'/images/stopPlayback.png'});bottomViewConfigOnOrientationMode(),screenBackgroundImage[1].height='iphone'==osname||'ipad'==osname?Titanium.Platform.displayCaps.platformHeight:Titanium.Platform.displayCaps.platformHeight/(Titanium.Platform.displayCaps.dpi/120),screenBackgroundImage[1].width=screenRes[0],Ti.Platform.displayCaps.platformWidth>Ti.Platform.displayCaps.platformHeight?(screenBackgroundImage[1].height=screenRes[1],Ti.API.info('Initial height for landscape '+screenBackgroundImage[1].height)):('ipad'==osname||'iphone'==osname?(screenBackgroundImage[1].height=Titanium.Platform.displayCaps.platformHeight-Titanium.Platform.displayCaps.platformHeight/2.5,Ti.API.info('Initial height for portrait ipad and iPhone '+screenBackgroundImage[1].height)):(screenBackgroundImage[1].height=Titanium.Platform.displayCaps.platformHeight/(Titanium.Platform.displayCaps.dpi/120),Ti.API.info('Initial height for portrait android'+screenBackgroundImage[1].height)),Inch>=InchValue&&('iphone'==osname||'ipad'==osname?(screenBackgroundImage[1].height=Titanium.Platform.displayCaps.platformHeight,Ti.API.info('Inch Height for iphone or ipad(portrait)'+screenBackgroundImage[1].height)):(screenBackgroundImage[1].height=Titanium.Platform.displayCaps.platformHeight/(Titanium.Platform.displayCaps.dpi/100),Ti.API.info('Inch Height for android(portrait)'+screenBackgroundImage[1].height)))),stopPlaybackView.add(stopPlaybackImage),playView.add(playImage),bottomMenu.add(playView),bottomMenu.add(recordView),bottomMenu.add(stopPlaybackView),bottomMenu.add(zoomout),bottomMenu.add(zoomin),notesbuttonview.add(notesbutton),bottomMenu.add(notesbuttonview),bottommenuMainView.add(bottomMenu);var isRecordStarted='false',db=Titanium.Database.open('Miscue'),audioFileExistCheckRow=db.execute('SELECT * FROM MiscueSession  WHERE userId = ? AND sessionGuid = ? AND sessionStatus != ?',userId,sessionGuid,'DELETED');Ti.API.info('---------- BEN - SELECT * FROM MiscueSession  WHERE userId = '+userId+' AND sessionGuid = '+sessionGuid+' AND sessionStatus != DELETED'),Ti.API.info('---------- BEN - '+audioFileExistCheckRow.count+' row(s) were returned');for(var i=0;i<audioFileExistCheckRow.fieldCount;i++)Ti.API.info('----------Ben - '+audioFileExistCheckRow.fieldName(i)+' = '+audioFileExistCheckRow.field(i));var file=audioFileExistCheckRow.fieldByName('recordedAudioFilename');Ti.API.info('---------- BEN!!! 1275 audioFile = '+file),'null'==file?Ti.API.info('---------- BEN!!! audioFile was null!'):(isRecordStarted='true',sound=Titanium.Media.createSound({volume:1,allowBackground:!0}),'android'==osname?(file=Ti.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory,file),sound.url=file.nativePath):(file=Titanium.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory,file),!1==file.exists()?(Ti.API.info('---------- BEN!!! audioFile was lost! recordedAudioFilename will be set to null in the database!'),alert('The audio file could not be loaded'),db.execute('UPDATE MiscueSession set recordedAudioFilename=\'null\'  WHERE userId = ? AND sessionGuid = ? AND sessionStatus != ?',userId,sessionGuid,'DELETED'),file='null'):(sound.url=file,Ti.API.info('---------- BEN!!! audioFile was found! Url = '+sound.url))),'null'!=file&&(playView.visible=!0,playView.touchEnabled=!0,playImage.image='/images/phase5/PLAY.png')),audioFileExistCheckRow.close(),db.close();var interval;if(Ti.App.Properties.setString('isAudioPlayingProcess','false'),Ti.API.log('Adding listener: '+Titanium.Platform.name),'android'!=Titanium.Platform.name){Titanium.Media.audioSessionMode=Titanium.Media.AUDIO_SESSION_MODE_PLAY_AND_RECORD;var recording=Ti.Media.createAudioRecorder();recording.compression=Ti.Media.AUDIO_FORMAT_AAC,recording.format=Titanium.Media.AUDIO_FILEFORMAT_MP4,Ti.Media.addEventListener('recordinginput',function(e){!e.available&&recording.recording&&recordView.fireEvent('click',{})});var timer,sound,newFile,recordedFileName='null';Ti.API.log('Adding listener1'),recordImage.addEventListener('click',function(){if(Ti.API.log('Starting record '+recordImage.image),'/images/phase5/RECORDFLASHING.png'==recordImage.image){if(file=recording.stop(),recordView.visible=!0,playView.visible=!0,clearInterval(interval),recordedFileName=file.getName(),playView.visible=!0,'android'!=Ti.Platform.osname){var permFileName=sessionGuid+'_'+file.getName(),permFile=Titanium.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory,permFileName);permFile.write(file.read),recordedFileName=permFileName,file=permFile}var db=Titanium.Database.open('Miscue');Ti.API.info('---------- BEN - recordedAudioFilename is being set on the database!!! recordedFileName = \''+recordedFileName+'\''),db.execute('UPDATE MiscueSession SET recordedAudioFilename =?, lastModifiedDate=?,isSessionModified = ?,isLastEditedSession = ? WHERE userId=? AND sessionGuid = ?',recordedFileName,createLastModifiedDate(),'true','true',userId,sessionGuid),db.close(),Titanium.Media.setOverrideAudioRoute(Titanium.Media.AUDIO_SESSION_OVERRIDE_ROUTE_SPEAKER),sound=Titanium.Media.createSound({url:file,volume:1,allowBackground:!0}),playImage.image='/images/phase5/PLAY.png',recordImage.image='/images/phase5/RECORD.png',playView.touchEnabled=!0,clearInterval(timer),Ti.Media.stopMicrophoneMonitor()}else if('/images/phase5/RECORD.png'==recordImage.image)Titanium.Media.setAudioSessionMode(Ti.Media.AUDIO_SESSION_MODE_RECORD),file=null,isRecordStarted='true',playView.touchEnabled=!1,stopPlaybackView.visible=!1,recordImage.image='/images/phase5/RECORDFLASHING.png',playView.visible=!1,interval=setInterval(flashRecord,500),recording.start(),Ti.Media.startMicrophoneMonitor(),duration=0;else if(Ti.API.log('Record problem'),!Ti.Media.canRecord)return void Ti.UI.createAlertDialog({title:'Error!',message:'No audio recording hardware is currently connected.'}).show()}),playImage.addEventListener('click',function(){sound&&sound.playing?(sound.pause(),playImage.image='/images/phase5/PLAY.png',recordImage.image='/images/phase5/RECORD.png',recordView.touchEnabled=!1,stopPlaybackView.visible=!0,recordView.visible=!1):(sound.addEventListener('complete',function(){Ti.App.Properties.setString('isAudioPlayingProcess','false'),playImage.image='/images/phase5/PLAY.png',recordImage.image='/images/phase5/RECORD.png',recordView.touchEnabled=!0,stopPlaybackView.visible=!1,recordView.visible=!0,playView.left='iphone'==osname?'51%':'49.5%'}),file.exists()&&(Ti.Media.defaultAudioSessionMode=Ti.Media.AUDIO_SESSION_MODE_PLAYBACK,sound.play(),Ti.App.Properties.setString('isAudioPlayingProcess','true'),playImage.image='/images/phase5/PAUSE.png',recordImage.image='/images/blurRecord.png',recordView.touchEnabled=!1,stopPlaybackView.visible=!0,recordView.visible=!1,playView.left=Ti.Platform.displayCaps.platformWidth<Ti.Platform.displayCaps.platformHeight?'iphone'==osname?'35.5%':'39.5%':'42%'))}),stopPlaybackView.addEventListener('click',function(e){sound.stop(),Ti.App.Properties.setString('isAudioPlayingProcess','false'),playImage.image='/images/phase5/PLAY.png',recordImage.image='/images/phase5/RECORD.png',recordView.touchEnabled=!0,stopPlaybackView.visible=!1,recordView.visible=!0,playView.left='iphone'==osname?'51%':'49.5%'})}if('android'==osname){var audioFile,path='',newAudioRecorder=Ti.Media.createAudioRecorder(),isRecordStarted='false';recordImage.addEventListener('click',function(e){if(Ti.API.info('Record image was clicked'),'/images/phase5/RECORD.png'==recordImage.image){Ti.API.info('---------- BEN - I am starting the recording...'),interval=setInterval(flashRecord,500),playView.visible=!1;var recordCount=sessionGuid.substr(sessionGuid.length-12,sessionGuid.length);path=learnername+'-'+recordCount,isRecordStarted='true',newAudioRecorder.start(),recordImage.image='/images/phase5/RECORDFLASHING.png',playView.touchEnabled=!1,isRecordStarted='true'}else{Ti.API.info('---------- BEN - I am stopping & saving the recording...'),clearInterval(interval),interval=null,recordView.visible=!0,playView.visible=!0,file=newAudioRecorder.stop(),Ti.API.info('---------- BEN - The recording has been saved to the cache: '+file.nativePath);var temp=file.nativePath.split('/'),tempFileName=temp[temp.length-1];sound=audioPlayer=Ti.Media.createAudioPlayer({url:file.nativePath}),recordImage.image='/images/phase5/RECORD.png',playView.visible=!0,playView.touchEnabled=!0,playImage.image='/images/phase5/PLAY.png'}});var isPlaying=!1;playImage.addEventListener('click',function(){!0==isPlaying?(isPlaying=!1,sound.pause(),playImage.image='/images/phase5/PLAY.png',recordImage.image='/images/phase5/RECORD.png',recordView.touchEnabled=!1,stopPlaybackView.visible=!0,recordView.visible=!1):(isPlaying=!0,sound.start(),Ti.App.Properties.setString('isAudioPlayingProcess','true'),playImage.image='/images/phase5/PAUSE.png',recordImage.image='/images/blurRecord.png',recordView.touchEnabled=!1,stopPlaybackView.visible=!0,recordView.visible=!1,playView.left=Ti.Platform.displayCaps.platformWidth<Ti.Platform.displayCaps.platformHeight?'39.5%':'42%',sound.addEventListener('complete',function(){isPlaying=!1,Ti.App.Properties.setString('isAudioPlayingProcess','false'),playImage.image='/images/phase5/PLAY.png',recordImage.image='/images/phase5/RECORD.png',recordView.touchEnabled=!0,stopPlaybackView.visible=!1,recordView.visible=!0,playView.left='49.5%','android'==osname&&(playView.left='50.5%')}))}),stopPlaybackView.addEventListener('click',function(e){sound.stop(),isPlaying=!1,Ti.App.Properties.setString('isAudioPlayingProcess','false'),playImage.image='/images/phase5/PLAY.png',recordImage.image='/images/phase5/RECORD.png',recordView.touchEnabled=!0,stopPlaybackView.visible=!1,recordView.visible=!0,playView.left='49.5%','android'==osname&&(playView.left='50.5%')})}var deleteAudioRecordLabel=[];deleteAudioRecordLabel.title=['Alert','Alert'],deleteAudioRecordLabel.message=['longpress_audio_delete','Long press will be delete your recorded audio session file. Do you want to continue?'],deleteAudioRecordLabel[1]=['Delete','Delete'],deleteAudioRecordLabel[2]=['Cancel','Cancel'];var deleteAudioDialog=r_HomeScreen.createLocalizedAlertDialog(deleteAudioRecordLabel,usrname);recordImage.addEventListener('longpress',function(){'/images/phase5/RECORD.png'==recordImage.image&&'true'==isRecordStarted&&deleteAudioDialog.show()}),deleteAudioDialog.addEventListener('click',function(e){if(0==e.index){var db=Titanium.Database.open('Miscue'),audioFileExistCheckRow=db.execute('SELECT * FROM MiscueSession  WHERE userId = ? AND sessionGuid = ?',userId,sessionGuid);if(file=audioFileExistCheckRow.fieldByName('recordedAudioFilename'),audioFileExistCheckRow.close(),'null'!=file){if('android'!=osname)file=Titanium.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory,file);else{var audioDir=Titanium.Filesystem.getFile(Titanium.Filesystem.externalStorageDirectory,'Miscue');file=Ti.Filesystem.getFile(audioDir.resolve(),file)}file.deleteFile(),playView.visible=!1,file='null',Ti.API.info('---------- BEN - recordedAudioFilename is being set on the database (2)!!! Hardcoded to = null'),db.execute('UPDATE MiscueSession SET recordedAudioFilename =?, lastModifiedDate=?,isSessionModified = ?,isLastEditedSession = ? WHERE userId=? AND sessionGuid = ?','null',createLastModifiedDate(),'true','true',userId,sessionGuid),db.close(),playImage.image='/images/blurPlay.png';var labelDeleteArray=[];labelDeleteArray.message=['search_Session_Deleted_Toast','Deleted'],r_HomeScreen.createLocalizedShowToastMessage(labelDeleteArray.message,usrname)}else audioFileExistCheckRow.close(),audioFileExistCheckRow=null,db.close(),db=null,alert('File does not exists')}});var fontsize=1.5,incount=0,outcount=0;zoomin.addEventListener('click',function(e){Ti.API.log('Zoom'),10!=incount&&(fontsize+=0.2,sessionwebview.evalJS('fontsize(\''+fontsize+'em\')'),incount++),outcount=0}),zoomout.addEventListener('click',function(e){10!=outcount&&1.3<fontsize&&(fontsize-=0.2,sessionwebview.evalJS('fontsize(\''+fontsize+'em\')'),outcount++,incount--)}),saveButton.addEventListener('click',function(e){'saveButton'==e.source.id&&('/images/phase5/RECORDFLASHING.png'==recordImage.image?alert('Record is in process'):saveMiscueSessionOnBackButton())}),backButton.addEventListener('click',function(e){if(Ti.API.info('Back button clicked!'+e.source.id),'backButton'==e.source.id){var dialog=Ti.UI.createAlertDialog({cancel:1,buttonNames:['Yes','Cancel'],message:'Do you want to go back? This will delete the current session',title:'Go Back'});dialog.addEventListener('click',function(e){if(e.index!==e.source.cancel){Ti.API.info('Back button still clicked!');var r_sessionBookPage=require('/MainMiscue/ui/sessionBookPage'),db=Titanium.Database.open('Miscue'),miscueSessionRow=db.execute('SELECT * FROM UserBook T1,MiscueSession T2 WHERE T2.sessionGuid = ? AND T2.userId = ? AND T1.bookGuid = ?',sessionGuid,userId,bookGuid),groupLearenrrow=db.execute('SELECT * FROM LearnerGroup G, Learner L WHERE L.groupGuid=G.groupGuid AND L.learnerGuid = ?',learnerguid),newBookWin=r_miscue.tt.ui.createBookNameWindow(usrname,miscueSessionRow.fieldByName('learnerGuid'),groupLearenrrow.fieldByName('learnerName'),token,groupLearenrrow.fieldByName('groupName'),button_Id,userId,menuItemKey);db.close(),newBookWin.open(),DeleteSession()}db.close(),newBookWin.open(),DeleteSession()}),dialog.show()}}),sessionWin.addEventListener('close',function(e){Ti.Gesture.removeEventListener('orientationchange',orientionChangeMode),0!=singleTapWindowCount&&(singletapwin.close(),singletapwin=null),menuBarView.close(),sessionWin.remove(groupNamelabels),sessionWin.remove(learnerNameLabels),sessionWin.remove(webviewcontainer),menuBarView=null,statusBarView=null,sessionWin=null}),notesbuttonview.addEventListener('click',function(e){if(!0==singletapwin.visible)miscueMenuCloseView.visible=!1,miscueMenuCloseView.touchEnabled=!1,singletapwin.close(),singletapwin.visible=!1,sessionwebview.touchEnabled=!0;else{var notewin=r_miscue.tt.ui.createnotecontentWindow(sessionGuid,usrname,isDeletedGroupLearnerBook,bookGuid,userId);notewin.open()}});var singletapwin;singletapwin='android'==Ti.Platform.osname?Ti.UI.createWindow({backgroundColor:'white',width:Titanium.UI.FILL,borderWidth:3,borderRadius:10,borderColor:'#888',height:Titanium.UI.FILL,layout:'vertical',visible:!1}):Ti.UI.createWindow({backgroundColor:'white',width:'58%',borderWidth:3,borderRadius:10,borderColor:'#888',height:Titanium.UI.size,layout:'vertical',visible:!1});var singletapLabel=Ti.UI.createLabel({top:'15dp',width:'97%',height:'80%',textAlign:'center',bottom:'10%',color:'black',font:{fontSize:'21dp',fontWeight:'bold'}}),deleteButton=Ti.UI.createButton({title:'[X] '+deleteLocalizedText,backgroundColor:'transparent',color:'red',style:Titanium.UI.iPhone.SystemButtonStyle.PLAIN,font:{fontSize:'20dp',fontWeight:'bold'}});singletapwin.add(singletapLabel),singletapwin.add(deleteButton);var singleindex;'android'==Ti.Platform.osname&&sessionWin.addEventListener('android:back',function(){'/images/phase5/RECORDFLASHING.png'==recordImage.image?alert('Record is in process'):saveMiscueSessionOnBackButton()}),recordView.add(recordImage);var singleTap=function(e){if(!1==tweetWindow.visible){miscueMenuCloseView.visible=!0,miscueMenuCloseView.touchEnabled=!0,sessionwebview.touchEnabled=!1,singleindex=e.spanIndex;var winhgth=Ti.Platform.displayCaps.platformHeight,winwidth=Ti.Platform.displayCaps.platformWidth;singletapwin.visible=!0,'yes'==isDeletedGroupLearnerBook&&(deleteButton.visible=!1),singleTapWindowCount++,'android'==Ti.Platform.osname?singletapwin.open():1==singleTapWindowCount&&singletapwin.open();var db=Titanium.Database.open('Miscue'),singletapmenurow=db.execute('SELECT * FROM MiscueSessionItem WHERE indexOfWord=? AND miscueSessionId=? ',singleindex,sessionGuid);if(1<=singletapmenurow.rowCount)for(var t=0;t<singletapmenurow.rowCount;t++){var quote='"',Labelname=singletapmenurow.fieldByName('additionalInfo');Labelname=Labelname.replace(/&apos;/gi,'\''),Labelname=Labelname.replace(/&quot;/gi,'"');var note=singletapmenurow.fieldByName('noteText');''==note?singletapLabel.text=Labelname:(note=note.replace(/&apos;/gi,'\''),singletapLabel.text=Labelname+'-"'+note+'"'),singletapmenurow.next()}singletapmenurow.close(),singletapmenurow=null,db.close(),db=null}};Ti.App.addEventListener('app:single',singleTap),deleteButton.addEventListener('click',function(e){miscueMenuCloseView.visible=!1,miscueMenuCloseView.touchEnabled=!1;var db=Titanium.Database.open('Miscue');db.execute('DELETE FROM MiscueSessionItem WHERE miscueSessionId=? AND indexOfWord = ?',sessionGuid,singleindex),miscueAccuracy=recalculateAccuracy(),db.execute('UPDATE MiscueSession SET isLastEditedSession = ? WHERE userId = ?','false',userId),db.execute('UPDATE MiscueSession SET accuracyValue =?, lastModifiedDate=?,isSessionModified = ?,isLastEditedSession = ? WHERE userId=? AND sessionGuid = ?',recalculateAccuracy(),createLastModifiedDate(),'true','true',userId,sessionGuid),db.close();var deletecount=0;sessionwebview.evalJS('winrefresh(\''+singleindex+'\',\''+backcolour+'\',\''+fontcolour+'\')'),deletecount++,sessionwebview.touchEnabled=!0,singletapwin.visible=!1,'android'==Ti.Platform.osname?singletapwin.close():singletapwin.hide()}),toolbarShowButton.addEventListener('click',function(e){0==menuBarView.visible?(toolbarShowButton.backgroundImage='/images/phase5/HIDEMENU.png',bottommenuMainView.animate({bottom:0,duration:animSpeed}),Ti.Platform.displayCaps.platformWidth<Ti.Platform.displayCaps.platformHeight?(sessionwebview.height='60%',slider.animate({bottom:'20%',duration:animSpeed}),upImageView.animate({bottom:'20%',duration:animSpeed}),downImageView.animate({bottom:'20%',duration:animSpeed}),accuracyLabel.animate({bottom:'15%',duration:animSpeed})):(sessionwebview.height='40%',slider.animate({bottom:'25%',duration:animSpeed}),upImageView.animate({bottom:'25%',duration:animSpeed}),downImageView.animate({bottom:'25%',duration:animSpeed}),accuracyLabel.animate({bottom:'21%',duration:animSpeed})),'ipad'==osname||6.8<=Inch?(webviewcontainer.height='100%',sessionwebview.top='0dp'):webviewcontainer.height='90%',menuBarView.visible=!0):(toolbarShowButton.backgroundImage='/images/phase5/SHOWMENU.png',6.8<=Inch?bottommenuMainView.animate({bottom:bottomMenuBottomDownValue,duration:animSpeed}):bottommenuMainView.animate({bottom:bottomMenuBottomDownValue,duration:animSpeed}),Ti.Platform.displayCaps.platformWidth<Ti.Platform.displayCaps.platformHeight?(sessionwebview.height='70%',slider.animate({bottom:'10%',duration:animSpeed}),upImageView.animate({bottom:'10%',duration:animSpeed}),downImageView.animate({bottom:'10%',duration:animSpeed}),accuracyLabel.animate({bottom:'5%',duration:animSpeed})):(sessionwebview.height='50%',slider.animate({bottom:'15%',duration:animSpeed}),upImageView.animate({bottom:'15%',duration:animSpeed}),downImageView.animate({bottom:'15%',duration:animSpeed}),accuracyLabel.animate({bottom:'10%',duration:animSpeed})),menuBarView.visible=!1,(6.8>Inch||'iphone'==osname)&&(webviewcontainer.height='90%'))}),bottommenuMainView.add(toolbarShowButton),sessionWin.add(bottommenuMainView);var orientCount=6;Ti.Gesture.addEventListener('orientationchange',orientionChangeMode);var tweetWindow;tweetWindow=Titanium.UI.createView({top:6.8<=Inch?'16%':'22%',visible:!1,backgroundColor:'white',borderWidth:'1dp',borderColor:'black',layout:'vertical',borderRadius:4});var miscueMenuCloseView=Ti.UI.createView({height:'100%',width:'100%',backgroundColor:'transparent',visible:!1,touchEnabled:!1});sessionWin.add(miscueMenuCloseView);var subwin=Ti.UI.createWindow({top:'20%',height:'200dp',width:'305dp',backgroundColor:'#302828',opacity:1}),subwinView=Ti.UI.createView({top:'10%',height:'100%',width:'100%',visible:!0,backgroundColor:'#302828'}),Label=Ti.UI.createLabel({top:10,text:'Enter the input',color:'white',width:subwin.width,font:{fontSize:'15dp',fontWeight:'bold'},textAlign:'center',touchEnabled:!1}),txtfield=Ti.UI.createTextArea({bottom:110,backgroundColor:'white',width:'285dp',left:'10dp',height:'40dp',editable:!0,enableReturnKey:!0,returnKeyType:Titanium.UI.RETURNKEY_DONE,focusable:!0,color:'black',font:{fontSize:'18dp',fontFamily:pagefontfamily}}),miscueTypeSaveButton=Ti.UI.createButton({bottom:55,width:'110dp',backgroundImage:'/images/button_bg_black.png',style:Titanium.UI.iPhone.SystemButtonStyle.BORDERED,height:'45dp',color:'white',title:'Save',left:'40dp'}),cancelButton=Ti.UI.createButton({bottom:55,width:'110dp',backgroundImage:'/images/button_bg_black.png',style:Titanium.UI.iPhone.SystemButtonStyle.BORDERED,height:'45dp',color:'white',title:'Cancel',right:'40dp'});subwinView.add(Label),subwinView.add(txtfield),subwinView.add(cancelButton),subwinView.add(miscueTypeSaveButton),subwin.add(subwinView);var miscue_menu,countval,additionalInfo,miscueMenuLabelId,startchar,endchar,valencr,selectedMiscueTypeColor,longTap=function(e){if('yes'!=isDeletedGroupLearnerBook){e.preventDefault;var val=e.data;countval=e.spanIndex,sessionwebview.evalJS('singleTapBackgroundColor(\''+countval+'\',\''+backcolour+'\',\''+fontcolour+'\')');var longtapleft=e.miscueMenuLeftValue;if(startChar=e.startchar,endChar=e.endchar,'heading'!=countval&&'htmlTap'!=countval&&'newtext2'!=countval&&'txt'!=countval&&(val=val.replace(/[&\/\\#+()$~%:*<>{}]/g,''),!1==tweetWindow.visible)){function createmiscueMenuTypeTable(){for(var tvData=[],db=Titanium.Database.open('Miscue'),userLanguageRow=db.execute('SELECT * FROM miscueType WHERE userId = ? AND isDeleted = ? ORDER BY position ASC',userId,'no'),array_count=0,j=3,counti=0,i=0;i<userLanguageRow.rowCount;i++){var miscueTypeId=userLanguageRow.fieldByName('id'),miscueTypeValue=userLanguageRow.fieldByName('text'),miscueTypeColor=userLanguageRow.fieldByName('colour');if(i<=rowcount){if(-1!=miscueTypeValue.search('prevword'))if(void 0==beforeword){userLanguageRow.next();continue}else miscueTypeValue=miscueTypeValue.replace('prevword',beforeword);if(-1!=miscueTypeValue.search('nextword'))if(''==afterword){userLanguageRow.next();continue}else miscueTypeValue=miscueTypeValue.replace('nextword',afterword);-1!=miscueTypeValue.search('word')&&(miscueTypeValue=miscueTypeValue.replace('word',strval));var groupLabel=Ti.UI.createLabel({bottom:'2dp',text:miscueTypeValue,color:'black',font:{fontSize:'16dp',fontWeight:'bold'},left:6.8<=Inch?55:35}),labelColor=Ti.UI.createLabel({bottom:'2dp',height:6.8<=Inch?'30dp':'20dp',width:6.8<=Inch?'30dp':'20dp',left:8,backgroundColor:miscueTypeColor}),row=Ti.UI.createTableViewRow({top:'5dp',height:6.8>Inch?Titanium.UI.SIZE:'45dp',id:miscueTypeId,row_id:groupLabel.text,backgroundColor:'transparent',colorId:miscueTypeColor});row.add(labelColor),row.add(groupLabel),tvData.push(row),userLanguageRow.next()}}tableView.setData(tvData),userLanguageRow.close(),userLanguageRow=null,db.close(),db=null}miscueMenuCloseView.visible=!0,miscueMenuCloseView.touchEnabled=!0,zoomin.touchEnabled=!1,zoomout.touchEnabled=!1,saveButton.touchEnabled=!1,notesbuttonview.touchEnabled=!1,'android'!=Ti.Platform.osname&&(sessionwebview.touchEnabled=!1),6.8>Inch?('android'==osname?tweetWindow.height='73%':(tweetWindow.height='70%','ipad'==osname&&(tweetWindow.height='35%')),tweetWindow.width='45%'):6.8<=Inch&&'android'==osname?(tweetWindow.top='30%',tweetWindow.height='59%',tweetWindow.width='40%'):(tweetWindow.height='48%',tweetWindow.width='42%');var leftTapValue=Titanium.Platform.displayCaps.platformWidth/2.5;'android'===Ti.Platform.name&&(leftTapValue/=Titanium.Platform.displayCaps.dpi/160),leftTapValue<=longtapleft?tweetWindow.left='2%':tweetWindow.right='2%';var tableView=Ti.UI.createTableView({top:5,bottom:0,separatorColor:'black',backgroundColor:'transparent'}),titleLabels=Ti.UI.createLabel({top:'5dp',height:30,color:'black',backgroundColor:'transparent',width:'100%',font:{fontSize:'16dp',fontWeight:'bold'},textAlign:'center',text:'"'+val+'"',touchEnabled:!1}),db=Titanium.Database.open('Miscue'),insertToModalwin=db.execute('SELECT * FROM UserBook T1,MiscueSession T2 WHERE T2.sessionGuid = ? AND T2.userId = ? AND T1.bookGuid = ?',sessionGuid,userId,bookGuid),encstr1=insertToModalwin.fieldByName('bookContents'),bookTitle=insertToModalwin.fieldByName('bookName');bookTitle=bookTitle.replace(/&quot;/gi,'\'');var copyOfBookTitle=bookTitle,insertionval=Ti.Utils.base64decode(encstr1);insertionval=bookTitle+' '+insertionval,insertToModalwin.close(),insertToModalwin=null,db.close(),db=null;var insertionconvertval=insertionval.toString();insertionconvertval=insertionconvertval.replace(/\r\n/gi,' '),insertionconvertval=insertionconvertval.replace(/( *\<br *\/> *)/gi,' <br /> '),insertionconvertval=insertionconvertval.replace(/(^\s*)|(\s*$)/gi,''),insertionconvertval=insertionconvertval.replace(/[ ]{2,}/gi,' '),insertionconvertval=insertionconvertval.replace(/\n/g,' ');var bookContent_Count=insertionconvertval.split(' ').length;if(Valstr=insertionconvertval.split(' '),0==countval)startchar=0,endchar=Valstr[countval].length;else{var previousvalue=Valstr[countval-1];if(null!==previousvalue&&'null'!==previousvalue&&void 0!==previousvalue&&'undefined'!==previousvalue)var previousvalueLength=previousvalue.length;var previousvalindex=countval-1}for(var lasttext,beforewordflag=!0,afterwordflag=!1,strx=insertionconvertval.split(' '),startCharPos=0,endCharPos=0,i=0;i<bookContent_Count;i++)if(endCharPos=startCharPos+strx[i].length-1,i==countval){var beforeword=strx[i-1],afterword='';i<bookContent_Count-1&&(afterword=strx[i+1]),'<br'==afterword&&i<bookContent_Count-3&&(afterword=strx[i+3]),'/>'==beforeword&&2<i&&(beforeword=strx[i-3]),null!=afterword&&(afterword=afterword.trim(),afterword=afterword.replace(/[&\/\\#+()$~%:*<>{}]/g,'')),null!=beforeword&&(beforeword=beforeword.trim(),beforeword=beforeword.replace(/[&\/\\#+()$~%:*<>{}]/g,'')),startchar=startCharPos,endchar=endCharPos;break}else startCharPos=endCharPos+2;var strval=val.toString(),val1='"';if(countval==bookContent_Count-1){var rowcount=10,beforewordstring=beforeword.toString();(6.8<=Inch||'ipad'==osname||3==i||5==i)&&(tweetWindow.height='ipad'==osname?'39%':'48%',i++);var lasttext=val1+strval+val1+'&'+val1+beforeword+val1}else if(0==countval){var afterwordstring=afterword.toString(),rowcount=10;(6.8<=Inch||'ipad'==osname)&&('ipad'==osname?tweetWindow.height='39%':tweetWindow.height='48%');var firsttext=val1+strval+val1+'&'+val1+afterword+val1}else var rowcount=12,beforewordstring=beforeword.toString(),afterwordstring=afterword.toString(),lasttext=val1+strval+val1+'&'+val1+beforeword+val1,firsttext=val1+strval+val1+'&'+val1+afterword+val1;createmiscueMenuTypeTable(),tweetWindow.add(titleLabels),tweetWindow.add(tableView),sessionWin.add(tweetWindow),tweetWindow.show(),tweetWindow.visible=!0,tableView.addEventListener('click',function(e){miscue_menu,additionalInfo=e.rowData.row_id,miscueMenuLabelId=e.rowData.id,selectedMiscueTypeColor=e.rowData.colorId,additionalInfo=additionalInfo.replace(/'/gi,'&apos;'),additionalInfo=additionalInfo.replace(/"/gi,'&quot;'),valencr=Ti.Utils.base64encode(val);var miscueTypeRequiredNote,db=Titanium.Database.open('Miscue'),miscueTypeRow=db.execute('SELECT * FROM miscueType WHERE id = ? AND userId = ?',miscueMenuLabelId,userId);if(0<miscueTypeRow.rowCount){miscueTypeRequiredNote=miscueTypeRow.fieldByName('requirenotes');var name=miscueTypeRow.fieldByName('id');miscue_menu=additionalInfo}miscueTypeRow.close(),miscueTypeRow=null,db.close(),db=null;var lastmodified_Date=createLastModifiedDate();if('false'==miscueTypeRequiredNote){var new_val='';miscueMenuCloseView.visible=!1,miscueMenuCloseView.touchEnabled=!1;var db=Titanium.Database.open('Miscue'),miscueTypeRow=db.execute('SELECT apiRef FROM miscueType WHERE userId = ? AND id = ?',userId,miscueMenuLabelId),apiRef=miscueTypeRow.fieldByName('apiRef');miscueTypeRow.close(),miscueTypeRow=null,db.close(),db=null,r_Miscuedb.insertMiscueSessionItem(sessionGuid,new_val,miscueMenuLabelId,countval,startchar,endchar,additionalInfo,apiRef),miscueAccuracy=recalculateAccuracy();var db=Titanium.Database.open('Miscue');db.execute('UPDATE MiscueSession SET accuracyValue =?, lastModifiedDate=?,isSessionModified = ?,isLastEditedSession = ? WHERE userId=? AND sessionGuid = ?',miscueAccuracy,createLastModifiedDate(),'true','true',userId,sessionGuid),db.close(),db=null;var colorVal=selectedMiscueTypeColor;sessionwebview.evalJS('addBackgroundcolor(\''+countval+'\',\''+colorVal+'\')'),tweetWindow.visible=!1,sessionWin.remove(tweetWindow),tweetWindow=null,tweetWindow=Titanium.UI.createView({top:6.8<=Inch?'16%':'22%',visible:!1,backgroundColor:'white',borderWidth:'1dp',borderColor:'black',layout:'vertical',borderRadius:4}),sessionwebview.touchEnabled=!0,zoomin.touchEnabled=!0,zoomout.touchEnabled=!0,saveButton.touchEnabled=!0,notesbuttonview.touchEnabled=!0,miscue_menu=null,countval=null,additionalInfo=null,miscueMenuLabelId=null,startchar=null,endchar=null,valencr=null}else sessionWin.remove(tweetWindow),tweetWindow=null,tweetWindow=Titanium.UI.createView({top:6.8<=Inch?'16%':'22%',visible:!1,backgroundColor:'white',borderWidth:'1dp',borderColor:'black',layout:'vertical',borderRadius:4}),subwin.addEventListener('open',function(e){txtfield.focus(),'android'==osname&&(txtfield.softKeyboardOnFocus=Ti.UI.Android.SOFT_KEYBOARD_SHOW_ON_FOCUS,subwin.activity.actionBar.hide())}),subwin.open(),subwinView.visible=!0,'android'==osname&&sessionWin.addEventListener('focus',function(e){Ti.UI.Android.hideSoftKeyboard()})})}}else{var labelArray=[];labelArray.title=['Alert','Alert'],labelArray.message=['group_Learner_Book_Delete_Message','Session cannot be modified as one or more of  group/learner/book is deleted'],labelArray[1]=['Ok','Ok'];var dialog=r_HomeScreen.createLocalizedAlertDialog(labelArray,usrname);dialog.show()}};return Ti.App.addEventListener('app:long',longTap),miscueTypeSaveButton.addEventListener('click',saveAdditionalInfo),cancelButton.addEventListener('click',function(e){miscueMenuCloseView.visible=!1,miscueMenuCloseView.touchEnabled=!1,sessionWin.remove(tweetWindow),tweetWindow=null,tweetWindow=Titanium.UI.createView({top:6.8<=Inch?'16%':'22%',visible:!1,backgroundColor:'white',borderWidth:'1dp',borderColor:'black',layout:'vertical',borderRadius:4}),sessionwebview.touchEnabled=!0,miscueMenuLabelId=null,miscue_menu=null,subwin.close(),subwinView.visible=!1,txtfield.value='',sessionwebview.evalJS('winrefresh(\''+countval+'\',\''+backcolour+'\',\''+fontcolour+'\')'),zoomin.touchEnabled=!0,zoomout.touchEnabled=!0,saveButton.touchEnabled=!0,notesbuttonview.touchEnabled=!0}),miscueMenuCloseView.addEventListener('click',function(e){miscueMenuCloseView.visible=!1,miscueMenuCloseView.touchEnabled=!1,!0==singletapwin.visible?(singletapwin.visible=!1,'android'==Ti.Platform.osname?singletapwin.close():singletapwin.hide(),sessionwebview.touchEnabled=!0,saveButton.touchEnabled=!0):!0==subwinView.visible?(miscueMenuCloseView.visible=!1,miscueMenuCloseView.touchEnabled=!1,sessionWin.remove(tweetWindow),tweetWindow=null,tweetWindow=Titanium.UI.createView({top:6.8<=Inch?'16%':'22%',visible:!1,backgroundColor:'white',borderWidth:'1dp',borderColor:'black',layout:'vertical',borderRadius:4}),sessionwebview.touchEnabled=!0,miscueMenuLabelId=null,miscue_menu=null,subwin.close(),subwinView.visible=!1,txtfield.value='',sessionwebview.evalJS('winrefresh(\''+countval+'\',\''+backcolour+'\',\''+fontcolour+'\')'),zoomin.touchEnabled=!0,zoomout.touchEnabled=!0,saveButton.touchEnabled=!0,notesbuttonview.touchEnabled=!0):(sessionWin.remove(tweetWindow),tweetWindow=null,tweetWindow=Titanium.UI.createView({top:6.8<=Inch?'16%':'22%',visible:!1,backgroundColor:'white',borderWidth:'1dp',borderColor:'black',layout:'vertical',borderRadius:4}),sessionwebview.evalJS('winrefresh(\''+countval+'\',\''+backcolour+'\',\''+fontcolour+'\')'),sessionwebview.touchEnabled=!0,zoomin.touchEnabled=!0,zoomout.touchEnabled=!0,saveButton.touchEnabled=!0,notesbuttonview.touchEnabled=!0)}),setTimeout(function(){toolbarShowButton.fireEvent('click')},1e3),sessionWin}})();