var r_miscue=require('/MainMiscue/miscue'),r_loadingScreen=require('/MainMiscue/ui/loadingScreen'),r_Miscuedb=require('/MainMiscue/model/Miscuedb'),r_Apifile=require('/MainMiscue/ui/Apifile'),r_styles=require('/MainMiscue/ui/styles'),r_HomeScreen=require('/MainMiscue/ui/HomeScreen');(function(){r_miscue.tt.ui.createmiscueMenuPage=function(userName,token,menuItemKey){function screenHeaderLabel(){Ti.Platform.displayCaps.platformWidth>Ti.Platform.displayCaps.platformHeight?(titleLabel.top=backView.height+backView.top-10,'android'==osname&&(titleLabel.top=backView.height+backView.top-60)):(titleLabel.top=backView.height+backView.top+10,Inch<InchValue&&(titleLabel.top=backView.height+backView.top))}function createMiscueMenupages(winWidth,userId,menuItemKey){var labelname,miscueMenu_ButtonId,imgData,position,db=Titanium.Database.open('Miscue'),holddatavar=db.execute('SELECT * FROM UserMenuItem WHERE userId = ? AND menuKey =?',userId,'miscueanalysismenu'),i=0,j=0,m=0,tableData=[],colorSetIndex=0,cellIndex=0;if('android'==osname){var tableHeight=Ti.Platform.displayCaps.platformHeight/2;tableHeight/=Titanium.Platform.displayCaps.dpi/160;var tableWidth=Ti.Platform.displayCaps.platformWidth-25;tableWidth/=Titanium.Platform.displayCaps.dpi/160}else{var tableHeight=Ti.Platform.displayCaps.platformHeight/2,tableWidth=Ti.Platform.displayCaps.platformWidth-25;if('ipad'==osname&&Ti.Platform.displayCaps.platformWidth<Ti.Platform.displayCaps.platformHeight)var tableWidth=Ti.Platform.displayCaps.platformWidth-60}(Inch<InchValue||Ti.Platform.displayCaps.platformWidth>Ti.Platform.displayCaps.platformHeight)&&(tableHeight-=15);var miscueMenuScreenIconWidth,miscueMenuScreenIconHeight;tableView=Ti.UI.createTableView({id:10,bottom:'1%',left:10,right:10,width:tableWidth,height:tableHeight,style:Ti.UI.iPhone.TableViewStyle.PLAIN,separatorColor:'transparent',backgroundColor:'transparent',scrollable:!1}),'ipad'==osname&&Ti.Platform.displayCaps.platformWidth<Ti.Platform.displayCaps.platformHeight&&(tableView.left=60);for(var thisRow,count=0,y=1;2>=y;y++){thisRow=Ti.UI.createTableViewRow({className:'grid',id:y,layout:'horizontal',height:tableView.height/2,backgroundColor:'transparent',backgroundSelectedColor:'transparent',separatorColor:'white'});for(var x=1;3>=x;x++){if(count<holddatavar.rowCount){0<holddatavar.rowCount&&(imgData=holddatavar.fieldByName('Image'),labelname=holddatavar.fieldByName('label_name'),miscueMenu_ButtonId=holddatavar.fieldByName('menuItemKey'),position=holddatavar.fieldByName('Position'));var thisView=Ti.UI.createView({backgroundColor:'transparent',viewid:x+1,left:'20dp',right:'10dp',height:thisRow.height-5,width:tableView.width/3-35});miscueMenuScreenIconHeight=thisView.height-65,miscueMenuScreenIconWidth=thisView.height-58,'iPhone OS'==Ti.Platform.name?'ipad'==osname&&(miscueMenuScreenIconHeight=thisView.height-75,miscueMenuScreenIconWidth=thisView.height-32):'android'==Ti.Platform.name&&Inch>=InchValue&&(miscueMenuScreenIconHeight=thisView.height-65,miscueMenuScreenIconWidth=thisView.height-32,Ti.Platform.displayCaps.platformWidth>Ti.Platform.displayCaps.platformHeight&&(miscueMenuScreenIconWidth=thisView.height-50)),'ipad'==osname&&(thisView.width=180),320==Titanium.Platform.displayCaps.dpi&&Inch>=InchValue&&(thisView.width=150),thisView.height<tableView.width/3-35&&(thisView.width=thisRow.height-5),Ti.Platform.displayCaps.platformWidth>Ti.Platform.displayCaps.platformHeight?((1==x&&1==y||1==x&&2==y)&&(thisView.left=tableView.width/3-(thisView.width-40),thisView.right='15dp'),2==holddatavar.rowCount&&1==x&&1==y&&(thisView.left=thisView.left+thisView.width/2+20,thisView.right='15dp'),4==holddatavar.rowCount&&1==x&&2==y&&(thisView.left=thisView.left+thisView.width+35,thisView.right='15dp'),5==holddatavar.rowCount&&1==x&&2==y&&(thisView.left=thisView.left+thisView.width/2+15,thisView.right='15dp')):(2==holddatavar.rowCount&&1==x&&1==y&&(thisView.left=thisView.width/2+15,thisView.right='15dp'),4==holddatavar.rowCount&&1==x&&2==y&&(thisView.left=thisView.width+35,thisView.right='15dp'),5==holddatavar.rowCount&&1==x&&2==y&&(thisView.left=thisView.width/2+20,thisView.right='15dp'));var thisButtonIcon=Ti.UI.createImageView(r_miscue.tt.combine(r_styles.$$.boldHeaderText,{width:miscueMenuScreenIconWidth,height:miscueMenuScreenIconHeight,bottom:Inch>=InchValue?'65dp':'55dp',buttonid:position,backgroundColor:'transparent',style:Titanium.UI.iPhone.SystemButtonStyle.PLAIN,image:imgData,iconid:miscueMenu_ButtonId,labelId:labelname}));120<thisButtonIcon.height&&(thisButtonIcon.height='android'==osname?'120dp':'130dp'),130<thisButtonIcon.width&&(thisButtonIcon.width='android'==osname?'130dp':'140dp'),thisButtonIcon.width>thisView.width&&(thisButtonIcon.width=thisView.width),Ti.Platform.displayCaps.platformWidth>Ti.Platform.displayCaps.platformHeight&&(thisButtonIcon.bottom='63dp',thisButtonIcon.width-=20),thisButtonIcon.height=thisButtonIcon.width;var thisLabel=Ti.UI.createLabel({backgroundColor:'transparent',color:fontcolour,left:'0dp',textAlign:'center',font:{fontSize:Inch>=InchValue?'20dp':'12dp',fontWeight:'bold',fontFamily:pagefontfamily},text:labelname,height:'68dp',iconid:miscueMenu_ButtonId,labelId:labelname,width:'96%',buttonid:position,bottom:'0dp'});26<thisLabel.text.length&&(thisLabel.text=thisLabel.text.substring(0,24)+'..'),thisButtonIcon.borderWidth=0,m++,thisView.add(thisButtonIcon),thisView.add(thisLabel),thisRow.add(thisView),cellIndex++,colorSetIndex++,holddatavar.next()}count++}tableData.push(thisRow)}return db.close(),tableView.data=tableData,miscueMenuWin.add(tableView),db.close(),tableView.addEventListener('click',tableViewClickEvent),tableData}function tableViewClickEvent(e){var index=e.index,row=e.source.ids,positionValue=e.source.buttonid,buttonId=e.source.iconid,labelTextName=e.source.labelId;if(null!=buttonId){var db=Titanium.Database.open('Miscue'),userMenuItemRow=db.execute('SELECT * FROM UserMenuItem WHERE userId = ? AND menuKey =? AND Position = ?',userId,menuItemKey,positionValue);if(0<userMenuItemRow.rowCount)var hmvalue=userMenuItemRow.fieldByName('Type'),buttonId=userMenuItemRow.fieldByName('menuItemKey');userMenuItemRow.close(),db.close(),Ti.Gesture.removeEventListener('orientationchange',orientionChangeMode)}switch(Ti.App.Properties.setString('isConvertedToDP','false'),buttonId){case'start':if(!0==isProcessInProgress){isProcessInProgress=!1;var db=Titanium.Database.open('Miscue'),groupcheckrow=db.execute('SELECT * FROM LearnerGroup WHERE loginUserId = ? AND deleted = ?',userId,'no');if(0<groupcheckrow.rowCount){db.close();var groupwindow=r_miscue.tt.ui.createGroupWindow(userName,token,userId,buttonId,menuItemKey);groupwindow.open(),miscueMenuWin.close(),tableView.removeEventListener('click',tableViewClickEvent),miscueMenuBackgroundImageView.remove(miscueMenuBackgroundImage),miscueMenuBackgroundImageView=null,miscueMenuBackgroundImage=null}else{db.close();var labelArray=[];labelArray.title=['Alert','Alert'],labelArray.message=['no_Group_Message','No Groups are assigned for this user'],labelArray[1]=['Ok','Ok'];var dialog=r_HomeScreen.createLocalizedAlertDialog(labelArray,userName);dialog.show(),isProcessInProgress=!0}groupcheckrow.close()}break;case'resume':if(!0==isProcessInProgress){isProcessInProgress=!1;var db=Titanium.Database.open('Miscue'),resumerow=db.execute('SELECT * FROM MiscueSession  WHERE userId = ? AND isLastEditedSession  = ? AND sessionStatus != ? ',userId,'true','DELETED'),resumeRowCount=resumerow.rowCount;if(0<resumeRowCount){var session_Guid=resumerow.fieldByName('sessionGuid'),bookGuid=resumerow.fieldByName('bookGUID'),miscueAccuracy=resumerow.fieldByName('accuracyValue'),learnerGuid=resumerow.fieldByName('learnerGuid');resumerow.close(),db.close();var isSessionBookPage='book',sessionwindow=r_miscue.tt.ui.createSessionWindow(userName,session_Guid,userId,token,bookGuid,isSessionBookPage,menuItemKey);sessionwindow.open(),miscueMenuWin.close(),tableView.removeEventListener('click',tableViewClickEvent),miscueMenuBackgroundImageView.remove(miscueMenuBackgroundImage),miscueMenuBackgroundImageView=null,miscueMenuBackgroundImage=null}else if(0==resumeRowCount){var labelArray=[];labelArray.title=['Alert','Alert'],labelArray.message=['no_Resume_Last_Message','User has not created any sessions or has deleted the last modified session'],labelArray[1]=['Ok','Ok'];var dialog=r_HomeScreen.createLocalizedAlertDialog(labelArray,userName);dialog.show(),isProcessInProgress=!0}break}case'search':if(!0==isProcessInProgress){isProcessInProgress=!1;var db=Titanium.Database.open('Miscue'),searchrow=db.execute('SELECT * FROM MiscueSession WHERE userId=? AND sessionStatus != ?',userId,'DELETED');if(0<searchrow.rowCount){var bookGuid=searchrow.fieldByName('bookGUID'),learnerGuid=searchrow.fieldByName('learnerGuid');db.close();var focusval=1,searchsessionwin=r_miscue.tt.ui.createsearchSession(userName,userId,token,menuItemKey);searchsessionwin.open(),miscueMenuWin.close(),tableView.removeEventListener('click',tableViewClickEvent),miscueMenuBackgroundImageView.remove(miscueMenuBackgroundImage),miscueMenuBackgroundImageView=null,miscueMenuBackgroundImage=null}else{db.close();var labelArray=[];labelArray.title=['Alert','Alert'],labelArray.message=['no_Session_Message','User has not created any sessions'],labelArray[1]=['Ok','Ok'];var dialog=r_HomeScreen.createLocalizedAlertDialog(labelArray,userName);dialog.show(),isProcessInProgress=!0}}}}function getOrientation(orientVal){var value;return value=1===orientVal?1:4===orientVal?2:2===orientVal?3:3===orientVal?4:0,value}function orientionChangeMode(e){return;var orientVal=e.source.orientation,orientationVal=getOrientation(orientVal);if(Inch>=InchValue&&orientationVal!=orientCount&&0!=orientationVal){orientCount=orientationVal;var screenRes=r_loadingScreen.backgroundImageHeightWidthPxToDp();miscueMenuBackgroundImage.height=screenRes[1],miscueMenuBackgroundImage.width=screenRes[0];var portraitval=r_loadingScreen.dptopixel();screenHeaderLabel();var lwidth=Ti.Platform.displayCaps.platformWidth;for(var x in tableView.removeEventListener('click',tableViewClickEvent),miscueMenuWin.children)if(3<=miscueMenuWin.children.length){tableDataValue=null,miscueMenuWin.remove(tableView);break}tableDataValue=createMiscueMenupages(lwidth,userId,menuItemKey)}}var osname=Ti.Platform.osname;Ti.API.info('miscue menu page');var pWidth=Ti.Platform.displayCaps.platformWidth,db=Titanium.Database.open('Miscue'),homelog=db.execute('SELECT * FROM Login WHERE username =?',userName),userId=homelog.fieldByName('userid'),userlang=homelog.fieldByName('userLanguage');homelog.close();var homerow=db.execute('SELECT * FROM UserSetting where loginId =?',userId),schoolnames=homerow.fieldByName('schoolName'),backpage=homerow.fieldByName('backPage'),backcolour=homerow.fieldByName('backgroundColor'),fontcolour=homerow.fieldByName('fontColor'),pagefontfamily=homerow.fieldByName('charFont'),miscueMenuWindowBackgroundImage=homerow.fieldByName('miscueMenuPageBackgroundImage'),dec=Ti.Utils.base64decode(schoolnames);Ti.API.info('dec string '+dec);var backView=r_loadingScreen.createBackButton(fontcolour,homerow.fieldByName('backImageURL'));homerow.close(),db.close();var iOS7=r_loadingScreen.isiOS7Plus(),miscueMenuWin=Ti.UI.createWindow({navBarHidden:!0,title:'Miscue',backgroundColor:'white'});Ti.App.Properties.setString('isConvertedToDP','true'),7<=iOS7&&(miscueMenuWin.top='20dp');var miscueMenuBackgroundImageView=Ti.UI.createView({backgroundColor:'transparent',height:Titanium.UI.FILL,width:Titanium.UI.FILL}),miscueMenuBackgroundImage=Ti.UI.createImageView({top:'0dp',backgroundColor:'#D8E028',image:miscueMenuWindowBackgroundImage});miscueMenuBackgroundImageView.add(miscueMenuBackgroundImage),miscueMenuWin.add(miscueMenuBackgroundImageView);var Inch=r_loadingScreen.screenInch(),screenRes=r_loadingScreen.backgroundImageHeightWidthPxToDp();miscueMenuBackgroundImage.height=screenRes[1],miscueMenuBackgroundImage.width=screenRes[0],'iphone'==osname&&(backView.height=48,backView.width=78),Inch<InchValue&&'android'==osname?(miscueMenuWin.orientationModes=[Titanium.UI.PORTRAIT],backView.height=50,backView.width=80):Inch>=InchValue?miscueMenuWin.orientationModes=[Titanium.UI.PORTRAIT]:'android'==osname&&(miscueMenuWin.orientationModes=[Titanium.UI.PORTRAIT]);var titleLabel=Ti.UI.createLabel({color:'#CEDEE6',width:pWidth,font:{fontSize:Inch<InchValue?'15dp':'30dp',fontWeight:'bold'},textAlign:'center',text:dec,touchEnabled:!1});screenHeaderLabel(),miscueMenuWin.add(titleLabel),miscueMenuWin.add(backView);var top=r_loadingScreen.titleLabeltop(),isProcessInProgress=!0;backView.addEventListener('click',function(e){if(!0==isProcessInProgress){isProcessInProgress=!1,miscueMenuWin.touchEnabled=!1;var labelArray=[];labelArray.message=['loading_Indicator','Loading..'],r_loadingScreen.showActivity(labelArray.message,userName),setTimeout(function(){miscueMenuWin.remove(backView),backView=null,Ti.Gesture.removeEventListener('orientationchange',orientionChangeMode);var refcheck=2,homeScreenWind=r_miscue.tt.ui.createHomeScreen(userName,token,refcheck);homeScreenWind.open(),r_loadingScreen.hideActivity(),miscueMenuWin.close(),miscueMenuWin=null,isProcessInProgress=null,Inch=null,miscueMenuBackgroundImageView.remove(miscueMenuBackgroundImage),miscueMenuBackgroundImageView=null,miscueMenuBackgroundImage=null},500)}}),'android'==Ti.Platform.osname&&miscueMenuWin.addEventListener('android:back',function(){if(!0==isProcessInProgress){isProcessInProgress=!1,miscueMenuWin.touchEnabled=!1;var labelArray=[];labelArray.message=['loading_Indicator','Loading..'],r_loadingScreen.showActivity(labelArray.message,userName),setTimeout(function(){miscueMenuWin.remove(backView),backView=null,Ti.Gesture.removeEventListener('orientationchange',orientionChangeMode);var refcheck=2,homeScreenWind=r_miscue.tt.ui.createHomeScreen(userName,token,refcheck);homeScreenWind.open(),r_loadingScreen.hideActivity(),miscueMenuWin.close(),miscueMenuWin=null,isProcessInProgress=null,Inch=null,miscueMenuBackgroundImageView.remove(miscueMenuBackgroundImage),miscueMenuBackgroundImageView=null,miscueMenuBackgroundImage=null},500)}});var tableView,tableDataValue;tableDataValue=Ti.Platform.displayCaps.platformWidth<Ti.Platform.displayCaps.platformHeight?createMiscueMenupages(pWidth,userId,menuItemKey):createMiscueMenupages(pWidth,userId);var isProcessInProgress=!0,orientCount=6;return Ti.Gesture.addEventListener('orientationchange',orientionChangeMode),miscueMenuWin}})();var r_sessionGroupPage=require('/MainMiscue/ui/sessionGroupPage'),r_searchSession=require('/MainMiscue/ui/searchSession');function getGroupLearner(xmlSync,userName,token,menuItemKey,homeWind){var i,j,isDeleted='no',docData=Ti.XML.parseString(xmlSync),responses=docData.getElementsByTagName('response'),result=docData.getElementsByTagName('result').item(0).textContent;if('REQUEST_OK'==result){var datas=docData.getElementsByTagName('data'),groups=datas.item(0).getElementsByTagName('groups'),group=groups.item(0).getElementsByTagName('group');Ti.API.info('group at miscue menu page returned from server');var db=Titanium.Database.open('Miscue'),grouploginrow=db.execute('SELECT * FROM Login  WHERE username=?',userName),loginUserId=grouploginrow.fieldByName('userid');grouploginrow.close();var groupUpdateRowCount=db.execute('SELECT * FROM LearnerGroup  WHERE loginUserId=?',loginUserId);if(0<groupUpdateRowCount.rowCount&&db.execute('UPDATE LearnerGroup SET deleted = ? WHERE loginUserId=? ','yes',loginUserId),groupUpdateRowCount.close(),db.close(),1<=group.length)for(i=0;i<group.length;i++){var groupname=responses.item(0).getElementsByTagName('group').item(i).getAttribute('name');groupname=groupname.replace(/'/gi,'&quot;');var groupguid=responses.item(0).getElementsByTagName('group').item(i).getAttribute('guid'),learner=group.item(i).getElementsByTagName('learners'),learnercount=group.item(i).getElementsByTagName('learner'),db=Titanium.Database.open('Miscue');db.execute('UPDATE Learner SET deleted = ? WHERE groupGuid=? AND userId =? ','yes',groupguid,loginUserId);var groupRowCount=db.execute('SELECT * FROM LearnerGroup  WHERE groupGuid=? AND loginUserId=?',groupguid,loginUserId);if(0<groupRowCount.rowCount?(groupRowCount.close(),db.execute('UPDATE LearnerGroup SET groupName=?, deleted = ? WHERE groupGuid=? AND loginUserId=? ',groupname,'no',groupguid,loginUserId),db.close()):(db.close(),r_Miscuedb.InsertGroup(groupguid,groupname,isDeleted,loginUserId)),1<=learnercount.length)for(j=0;j<learnercount.length;j++){var learnername=group.item(i).getElementsByTagName('learner').item(j).textContent;learnername=learnername.replace(/'/gi,'&quot;');var learnerimage=group.item(i).getElementsByTagName('learner').item(j).getAttribute('portraitURL');Ti.API.info('learner image at miscue menu screen response from server '+learnerimage);var learnerguid=group.item(i).getElementsByTagName('learner').item(j).getAttribute('guid'),db=Titanium.Database.open('Miscue'),learnerRowcount=db.execute('SELECT * FROM Learner  WHERE learnerGuid=? AND groupGuid=? AND userId = ?',learnerguid,groupguid,loginUserId);0<learnerRowcount.rowCount?(learnerRowcount.close(),db.execute('UPDATE Learner SET learnerName=?,learnerImage =?,deleted = ? WHERE groupGuid=? AND  learnerGuid = ? AND userId =? ',learnername,learnerimage,'no',groupguid,learnerguid,loginUserId),db.close()):(db.close(),r_Miscuedb.Insertlearner(learnerguid,groupguid,learnername,learnerimage,isDeleted,loginUserId))}}var base_URL='https://www.miscue.co.uk/iglooapi/apirequest.aspx',getbook='<request><requesttype>GETBOOKS</requesttype><accesstoken>'+token+'</accesstoken></request>',flg=4;r_Apifile.createApi(base_URL,getbook,userName,token,flg,homeWind,loginUserId,menuItemKey)}else if('REQUEST_OK'!=result){r_loadingScreen.hideActivity();var error=docData.getElementsByTagName('error'),MyNodeList=docData.childNodes;Ti.API.info('docData has '+MyNodeList.length+' node(s)');for(var i=0;i<MyNodeList.length;i++)Ti.API.info('Node '+i+' is '+MyNodeList[i]);for(var i=0;i<MyNodeList.length;i++)Ti.API.info('Node '+i+' is called '+MyNodeList[i].nodeName);for(var i=0;i<MyNodeList.length;i++)Ti.API.info('Node '+i+' has a value of '+MyNodeList[i].nodeValue);var message=error.item(0).getElementsByTagName('message').item(0).text,labelArray=[];labelArray.title=['Alert','Alert'],labelArray.message=['invalid_Session_Message',message],labelArray[1]=['Ok','OK'];var dialog=r_HomeScreen.createLocalizedAlertDialog(labelArray,userName);dialog.show(),dialog.addEventListener('click',function(e){if(0==e.index){var db=Titanium.Database.open('Miscue');db.execute('UPDATE Login SET logoutFlag=? WHERE userid=?',2,loginUserId),db.close();var loginWin=r_miscue.tt.ui.createLoginPage();loginWin.open(),homeWind.close()}})}}exports.getGroupLearner=getGroupLearner;function createBooksTest(xmldata,userName,token,miscueWind,userId,menuItemKey){var xmldata1=xmldata.replace(/"  >/g,'" ><![CDATA['),xmldata2=xmldata1.replace(/<\/book>/gi,']]></book>'),xmldata3=xmldata2.replace(/<br/gi,' <br');xmldata3=xmldata3.replace(/\/>/gi,'/> ');var i,j,isDeleted='no',status='null',xmlSync=xmldata3,docData=Ti.XML.parseString(xmlSync),responses=docData.getElementsByTagName('response'),datas=docData.getElementsByTagName('data'),result=docData.getElementsByTagName('result').item(0).textContent;if('REQUEST_OK'==result){var books=datas.item(0).getElementsByTagName('books');if(0<books.length){var book=books.item(0).getElementsByTagName('book');if(0<book.length){var db=Titanium.Database.open('Miscue'),grouploginrow=db.execute('SELECT * FROM Login  WHERE username=?',userName),userId=grouploginrow.fieldByName('userid');grouploginrow.close();var bookRowCheck=db.execute('SELECT * FROM UserBook WHERE userId = ?',userId);0<bookRowCheck.rowCount&&db.execute('UPDATE UserBook SET deleted = ? WHERE userId = ? AND bookType = ?','yes',userId,'R'),bookRowCheck.close(),db.close();for(var bookImage='',date='',lastSavedServerDate=null,lastmodifiedDate='',isManuallyAdded='false',i=0;i<book.length;i++){var notesTemplate=books.item(0).getElementsByTagName('book').item(i).getAttribute('notesTemplate').toString(),sliderValues=books.item(0).getElementsByTagName('book').item(i).getAttribute('sliderValues').toString();Ti.API.info('Slider Values for book: '+i+' : '+sliderValues),notesTemplate=notesTemplate.replace(/\\n/gi,'\n');var bookContent=books.item(0).getElementsByTagName('book').item(i).textContent;bookContent='android'==Ti.Platform.osname?bookContent.replace(/\r\n/gi,' '):bookContent.replace(/\n/gi,' ');var checkString=bookContent.substring(bookContent.length-8,bookContent.length);'<br />'==checkString.trim()&&(bookContent=bookContent.substring(0,bookContent.length-8),bookContent=bookContent.replace(/<br ?\/?>  <br ?\/?>/gi,'<br />'));var bookGuid=books.item(0).getElementsByTagName('book').item(i).getAttribute('guid'),extraHTML=books.item(0).getElementsByTagName('book').item(i).getAttribute('extraHTML');extraHTML=extraHTML.replace(/%3c/gi,'<'),extraHTML=extraHTML.replace(/%2f/gi,'/'),extraHTML=extraHTML.replace(/%3e/gi,'>'),extraHTML=extraHTML.replace(/\+/g,' '),extraHTML=extraHTML.replace(/%3d/gi,'='),extraHTML=extraHTML.replace(/%27/gi,'\''),extraHTML=extraHTML.replace(/%3a/gi,':'),extraHTML=extraHTML.replace(/%3a/gi,':'),Ti.API.info('extraHTMLMAL '),Ti.API.info('extraHTML '+extraHTML),extraHTML=Ti.Utils.base64encode(extraHTML);var bookName=books.item(0).getElementsByTagName('book').item(i).getAttribute('name');bookName=bookName.replace(/'/gi,'&quot;');var bookType=books.item(0).getElementsByTagName('book').item(i).getAttribute('type');bookImage=books.item(0).getElementsByTagName('book').item(i).getAttribute('pictureURL');var bookContent=Ti.Utils.base64encode(bookContent),db=Titanium.Database.open('Miscue'),bookRow=db.execute('SELECT * FROM UserBook WHERE bookGuid=? AND userId = ?',bookGuid,userId);0<bookRow.rowCount?(bookRow.close(),db.execute('UPDATE UserBook SET  deleted = ?, bookName = ?, bookContents = ?, notesTemplate = ?, extraHTML = ?, sliderValues = ? WHERE userId=? AND bookGuid = ? ','no',bookName,bookContent,notesTemplate,extraHTML,sliderValues,userId,bookGuid),db.close()):(db.close(),Ti.API.info('book contents from server '+bookContent),Ti.API.info('book name from server '+bookName),r_Miscuedb.insertBook(bookContent,bookName,bookGuid,bookImage,bookType,isDeleted,status,date,lastmodifiedDate,isManuallyAdded,lastSavedServerDate,userId,notesTemplate,extraHTML,sliderValues))}}}r_loadingScreen.hideActivity(),miscueWind.touchEnabled=!0;var miscuewindow=r_miscue.tt.ui.createmiscueMenuPage(userName,token,menuItemKey);miscuewindow.open(),miscueWind.close()}else if('REQUEST_OK'!=result){r_loadingScreen.hideActivity(),miscueWind.touchEnabled=!0;var error=docData.getElementsByTagName('error'),message=error.item(0).getElementsByTagName('message').item(0).textContent,labelArray=[];labelArray.title=['Alert','Alert'],labelArray.message=['invalid_Session_Message',message],labelArray[1]=['Ok','OK'];var dialog=r_HomeScreen.createLocalizedAlertDialog(labelArray,userName);dialog.show(),dialog.addEventListener('click',function(e){if(0==e.index)if('Invalid or expired session ID'==message){var db=Titanium.Database.open('Miscue');db.execute('UPDATE Login SET logoutFlag=? WHERE userid=?',2,userId),db.close();var loginWin=r_miscue.tt.ui.createLoginPage();loginWin.open(),miscueWind.close()}else message='Continuing with local data',showToastMessage(message)})}}exports.createBooksTest=createBooksTest;